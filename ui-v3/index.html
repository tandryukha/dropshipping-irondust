<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>health.ee ‚Äî Desktop Wireframe v2 (Amazon.de proportions)</title>
    <style>
      :root {
        --bg: #f2f3f5;
        --surface: #ffffff;
        --text: #111111;
        --muted: #6b7280;
        --brand: #131921; /* Amazon-like dark header */
        --accent: #ff9900; /* Amazon-like accent */
        --chip-bg: #eef2f7;
        --chip-text: #1f2937;
        --border: #e5e7eb;
        --star: #f59e0b;
        --topbar-h: 64px;
        --rail-w: 300px; /* Amazon filter sidebar width */
        --basket-w: 130px; /* Narrow basket column, max 130px on MacBook 16 */
        --price: #b12704; /* Amazon price red */
        --yellow: #f7ca00; /* Amazon yellow outline */
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        font: 14px/1.4 -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        color: var(--text);
        background: var(--bg);
      }
      :focus-visible { outline: 2px solid #111; outline-offset: 2px; }

      /* Top header like Amazon */
      .topbar {
        position: relative; z-index: 50;
        height: var(--topbar-h);
        background: var(--brand); color: #fff;
        display: grid; grid-template-columns: 130px 110px 1fr 200px 140px; gap: 8px; align-items: center;
        padding: 6px 12px;
        border-bottom: 1px solid rgba(255,255,255,0.08);
      }
      .logo { 
        font-size: 30px; 
        font-weight: 800; 
        letter-spacing: -.3px;
        padding: 2px 8px;
        border: 1px solid transparent;
        border-radius: 2px;
        cursor: pointer;
      }
      .logo:hover { border-color: rgba(255,255,255,0.3); }
      .logo .tld { color: var(--accent); font-size: 20px; }
      
      .location-picker {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 8px;
        border: 1px solid transparent;
        border-radius: 2px;
        cursor: pointer;
        line-height: 1.2;
      }
      .location-picker:hover { border-color: rgba(255,255,255,0.3); }
      .location-picker .icon { display: inline-flex; width: 18px; height: 18px; line-height: 0; }
      .location-picker .icon svg { width: 18px; height: 18px; stroke: #fff; }
      .location-picker #desktopDeliveryLabel { font-size: 14px; font-weight: 700; }
      .location-picker .label { font-size: 11px; color: #ccc; font-weight: 400; }
      .location-picker .city { font-size: 16px; font-weight: 800; color: #fff; }
      .location-picker .text { display: flex; flex-direction: column; }
      .location-picker .label { font-size: 11px; color: #ccc; font-weight: 400; }
      .location-picker .city { font-size: 14px; font-weight: 700; }
      
      .nav-right { display: flex; gap: 0; align-items: stretch; }
      .nav-item {
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding: 6px 10px;
        border: 1px solid transparent;
        border-radius: 2px;
        cursor: pointer;
        line-height: 1.2;
      }
      .nav-item:hover { border-color: rgba(255,255,255,0.3); }
      .nav-item .top { font-size: 11px; color: #ccc; font-weight: 400; }
      .nav-item .bottom { font-size: 14px; font-weight: 700; white-space: nowrap; }
      
      .lang-selector {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 6px 8px;
        border: 1px solid transparent;
        border-radius: 2px;
        cursor: pointer;
        position: relative;
      }
      .lang-selector:hover { border-color: rgba(255,255,255,0.3); }
      .lang-selector .flag { font-size: 18px; }
      .lang-selector .lang { font-size: 14px; font-weight: 700; }
      .lang-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        margin-top: 4px;
        display: none;
        z-index: 100;
        min-width: 120px;
      }
      .lang-selector:hover .lang-dropdown { display: block; }
      .lang-dropdown .lang-option {
        padding: 10px 16px;
        cursor: pointer;
        color: #111;
        font-size: 14px;
        border-bottom: 1px solid var(--border);
      }
      .lang-dropdown .lang-option:last-child { border-bottom: none; }
      .lang-dropdown .lang-option:hover { background: #f3f3f3; }
      .lang-dropdown .lang-option.active { 
        background: #e8f4f8; 
        font-weight: 700;
      }
      
      .account-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        margin-top: 4px;
        display: none;
        z-index: 100;
        min-width: 280px;
        padding: 16px;
      }
      .nav-item:hover .account-dropdown { display: block; }
      .account-dropdown .signin-btn {
        background: linear-gradient(to bottom, #f7dfa5, #f0c14b);
        border: 1px solid #a88734;
        border-radius: 3px;
        color: #111;
        font-size: 13px;
        font-weight: 400;
        padding: 8px;
        width: 100%;
        cursor: pointer;
        text-align: center;
        display: block;
        text-decoration: none;
        box-shadow: 0 1px 0 rgba(255,255,255,.4) inset;
      }
      .account-dropdown .signin-btn:hover {
        background: linear-gradient(to bottom, #f5d78e, #edb933);
      }
      .account-dropdown .new-customer {
        text-align: center;
        font-size: 13px;
        margin-top: 12px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border);
        color: #111;
      }
      .account-dropdown .new-customer a {
        color: #007185;
        text-decoration: none;
      }
      .account-dropdown .new-customer a:hover {
        color: #c7511f;
        text-decoration: underline;
      }
      .account-dropdown .dropdown-header {
        padding: 16px 0 8px 0;
        font-size: 16px;
        font-weight: 700;
        color: #111;
      }
      .account-dropdown .dropdown-section {
        padding: 0;
      }
      .account-dropdown .dropdown-item {
        padding: 6px 0;
        cursor: pointer;
        color: #111;
        font-size: 13px;
        display: block;
        text-decoration: none;
      }
      .account-dropdown .dropdown-item:hover { 
        color: #c7511f;
        text-decoration: underline;
      }
      
      .cart-nav {
        display: flex;
        align-items: flex-end;
        gap: 4px;
        padding: 6px 8px;
        border: 1px solid transparent;
        border-radius: 2px;
        cursor: pointer;
        position: relative;
      }
      .cart-nav:hover { border-color: rgba(255,255,255,0.3); }
      .cart-nav .cart-icon {
        width: 40px;
        height: 32px;
        position: relative;
        margin-bottom: -4px;
        margin-left: -10px;
      }
      .cart-nav .cart-icon svg {
        width: 100%;
        height: 100%;
        fill: none;
        stroke: #fff;
        stroke-width: 2.5;
      }
      .cart-nav .label { 
        font-size: 13px; 
        font-weight: 700; 
        margin-bottom: 2px;
        line-height: 1.1;
      }
      .cart-nav .badge-top {
        position: absolute;
        top: 2px;
        left: 14px;
        background: var(--accent);
        color: #111;
        border-radius: 999px;
        padding: 0 6px;
        font-weight: 800;
        font-size: 14px;
        line-height: 20px;
        min-width: 20px;
        text-align: center;
      }

      /* Mobile-only header bits (hidden by default) */
      .burger, .mobile-signin { display: none; }

      .searchbar {
        display: flex;
        align-items: stretch;
        background: #fff;
        border-radius: 4px;
        overflow: hidden;
      }
      .searchbar select { 
        border: none;
        padding: 6px 8px;
        background: #f3f3f3;
        border-right: 1px solid #ccc;
        font-size: 11px;
        cursor: pointer;
        outline: none;
        color: #555;
        max-width: 50px;
        font-weight: 400;
      }
      .searchbar select:hover { background: #e6e6e6; }
      .search { 
        display: flex; 
        align-items: center; 
        flex: 1;
        padding: 0 8px;
      }
      .search input { 
        border: 0; 
        outline: 0; 
        flex: 1; 
        font-size: 15px; 
        padding: 8px 4px;
      }
      .search-btn { 
        background: var(--accent); 
        color: #111; 
        border: 0; 
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .search-btn .icon { font-size: 20px; }

      /* Layout: left rail (filters) ‚Äî main (results) */
      .shell {
        padding: 0 16px 12px 16px; 
        display: grid; 
        gap: 16px;
        grid-template-columns: var(--rail-w) 1fr; /* 2 columns: filters + main */
      }

      /* Left filters */
      .filters { align-self: start; margin-top: 12px; }
      .panel { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 12px; }
      .panel + .panel { margin-top: 4px; }
      .panel .h { display: flex; align-items: center; justify-content: space-between; font-weight: 800; margin-bottom: 8px; }
      .muted { color: var(--muted); }
      .chips { display: flex; flex-wrap: wrap; gap: 6px; }
      .chip { background: var(--chip-bg); color: var(--chip-text); border: 1px solid var(--border); border-radius: 999px; padding: 6px 10px; cursor: pointer; font-weight: 600; font-size: 12px; }
      .chip.active { background: #111; color: #fff; border-color: #111; }
      .check { display: flex; align-items: center; gap: 8px; margin: 6px 0; }
      .link { border: 0; background: transparent; color: #2563eb; padding: 0; cursor: pointer; font-weight: 600; font-size: 12px; }

      /* Toolbar - full width like second header */
      .toolbar { 
        position: relative;
        z-index: 40;
        background: var(--surface);
        display: flex; 
        align-items: center; 
        justify-content: space-between; 
        gap: 12px; 
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      }
      
      /* Main ‚Äî Results */
      .main { min-height: 80vh; margin-top: 12px; }
      .toolbar .left { display: flex; gap: 12px; align-items: center; }
      .toolbar .left #count { font-size: 14px; font-weight: 400; color: #0f1111; }
      .toolbar .left .meta { display: none; } /* Hide the "Fast shipping ‚Ä¢ Free returns" in toolbar */
      .toolbar .right { display: flex; gap: 8px; align-items: center; }
      .toolbar .sort-label { font-size: 12px; font-weight: 400; color: #565959; }
      .toolbar #sort { 
        border: 1px solid #d5d9d9; 
        background: #f0f2f2; 
        color: #0f1111; 
        border-radius: 8px; 
        padding: 6px 8px 6px 10px; 
        cursor: pointer; 
        font-size: 13px;
        font-weight: 400;
        box-shadow: 0 2px 5px 0 rgba(213,217,217,.5);
      }
      .toolbar #sort:hover {
        background: #e3e6e6;
        border-color: #d5d9d9;
      }
      .btn { border: 1px solid var(--border); background: #fff; color: #111; border-radius: 6px; padding: 6px 10px; cursor: pointer; font-weight: 700; }
      .btn.primary { background: var(--accent); color: #111; border-color: #eab308; }
      .btn.add { 
        background: #FFD814;
        border: 1px solid #FCD200;
        border-radius: 20px;
        color: #0F1111; 
        box-shadow: 0 2px 5px 0 rgba(213,217,217,.5);
        font-weight: 400;
        padding: 8px 16px;
      }
      .btn.add:hover {
        background: #F7CA00;
        border-color: #F2C200;
      }
      .btn.add:active {
        background: #F0B800;
        box-shadow: 0 1px 3px 0 rgba(213,217,217,.5);
      }
      .active-pills { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
      .pill { background: #111; color: #fff; border-radius: 999px; padding: 6px 10px; font-weight: 700; font-size: 12px; display: inline-flex; gap: 8px; align-items: center; }
      .pill .x { cursor: pointer; opacity: .9; }
      .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; } /* Changed from 3 to 4 columns */
      .pager { display: flex; justify-content: center; gap: 6px; margin: 10px 0; }
      .pager .btn { min-width: 32px; }
      .btn.current { background: #111; color: #fff; border-color: #111; }
      .product { background: #fff; border: 1px solid var(--border); border-radius: 6px; padding: 10px; display: flex; flex-direction: column; gap: 8px; transition: box-shadow .15s ease; }
      .product:hover { box-shadow: 0 8px 18px rgba(0,0,0,0.06); }
      .thumb { width: 100%; height: 180px; background: #e5e7eb; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #9ca3af; font-weight: 800; }
      .p-title { font-weight: 700; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; min-height: 36px; }
      /* Hide mobile-only bars on desktop by default */
      .mobile-filterbar { display: none; }
      .p-brand { color: var(--muted); font-size: 12px; }
      .p-stars { color: var(--star); font-size: 12px; }
      .p-price { font-weight: 900; margin: 6px 0; }
      .price { display: flex; align-items: flex-start; gap: 2px; }
      .price .currency { font-size: 12px; margin-top: 2px; }
      .price .whole { font-size: 18px; line-height: 1; }
      .price .fraction { font-size: 12px; position: relative; top: -2px; }
      .p-cta { display: flex; align-items: center; gap: 8px; }
      .small { font-size: 12px; }

      /* Right ‚Äî Basket - Full height popup style */
      .basket { 
        position: fixed;
        top: 0;
        right: -130px; /* Hidden by default */
        width: 130px;
        height: 100vh;
        background: #fff;
        border-left: 1px solid var(--border);
        box-shadow: -4px 0 12px rgba(0,0,0,0.1);
        z-index: 100;
        transition: right 0.3s ease;
        overflow-y: auto;
        display: block;
      }
      
      /* When basket is visible */
      .basket.visible { right: 0; }
      
      /* Narrow the page when basket is open */
      body.basket-open .topbar {
        margin-right: 130px;
        transition: margin-right 0.3s ease;
      }
      body.basket-open .toolbar {
        margin-right: 130px;
        transition: margin-right 0.3s ease;
      }
      body.basket-open .shell {
        margin-right: 130px;
        transition: margin-right 0.3s ease;
      }
      .basket .close-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: transparent;
        border: 0;
        font-size: 18px;
        cursor: pointer;
        color: #111;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        z-index: 101;
      }
      .basket .close-btn:hover { background: #f0f0f0; }
      .basket .summary { padding: 40px 8px 10px 8px; }
      .basket .subhead { color: var(--muted); text-align: center; font-size: 11px; }
      .basket .subtotal { text-align: center; font-weight: 800; }
      .basket .subtotal .price { color: var(--price); font-size: 16px; display: block; margin-top: 2px; }
      .basket .free-msg { text-align: center; font-size: 10px; line-height: 1.3; margin-top: 6px; }
      .basket .free-msg b { font-weight: 900; }
      .basket .free-link { text-align: center; margin-top: 4px; }
      .basket .free-link a { color: #2563eb; text-decoration: none; font-size: 10px; }
      .basket .go { display: block; width: 100%; background: #fff; border: 1px solid #111; border-radius: 999px; padding: 6px 8px; font-weight: 800; cursor: pointer; margin-top: 8px; font-size: 11px; }
      .basket .items { border-top: 1px solid var(--border); }
      .basket .item-block { padding: 10px 6px; border-bottom: 1px solid var(--border); }
      .basket .pimg { width: 100%; max-width: 110px; height: 110px; margin: 0 auto; background: #e5e7eb; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #9ca3af; font-weight: 700; font-size: 10px; }
      .basket .price { color: var(--text); text-align: center; font-weight: 900; margin-top: 6px; font-size: 13px; }
      .basket .price .val { color: var(--price); }
      .qty-ctrl { margin: 6px auto 0; display: grid; grid-auto-flow: column; align-items: center; justify-content: center; gap: 6px; border: 2px solid var(--yellow); border-radius: 999px; padding: 4px 8px; width: fit-content; }
      .qty-ctrl .trash, .qty-ctrl .plus { background: transparent; border: 0; cursor: pointer; font-size: 14px; padding: 0; line-height: 1; }
      .qty-ctrl .count { font-weight: 900; min-width: 12px; text-align: center; font-size: 12px; }

      /* Suggestions dropdown under search */
      .sugg { position: absolute; z-index: 1000; }
      .sugg .box { background: #fff; border: 1px solid var(--border); border-radius: 10px; overflow: hidden; box-shadow: 0 10px 20px rgba(0,0,0,.08); }
      .sugg .row { display: flex; align-items: center; gap: 8px; padding: 10px 12px; cursor: pointer; }
      .sugg .row:hover { background: #fafafa; }
      .sugg .match { font-weight: 700; }
      .sugg .meta { margin-left: auto; color: var(--muted); font-size: 12px; }

      /* Carousel for browsing history */
      .carousel-wrapper { position: relative; overflow: hidden; }
      .carousel { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; transition: transform 0.3s ease; }
      .carousel .product { min-width: 0; }
      .carousel .thumb { height: 140px; }
      .carousel .p-title { font-size: 13px; min-height: 32px; -webkit-line-clamp: 3; line-clamp: 3; }
      .carousel .p-cta { flex-direction: column; }
      .carousel .btn { width: 100%; font-size: 11px; padding: 5px 8px; }
      .carousel-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.95); border: 1px solid var(--border); border-radius: 4px; width: 40px; height: 80px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 10; }
      .carousel-nav:hover { background: #fff; }
      .carousel-nav.prev { left: -10px; }
      .carousel-nav.next { right: -10px; }
      .carousel-nav:disabled { opacity: 0.3; cursor: not-allowed; }
      
      /* Price range slider - Amazon style */
      .price-range { margin: 0 0 12px 0; }
      .price-display { 
        font-size: 12px;
        color: #0f1111;
        font-weight: 400;
        margin-bottom: 10px;
      }
      .price-slider-container {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .price-slider-wrapper {
        flex: 1;
        position: relative;
        padding: 0 10px;
      }
      .price-slider { 
        position: relative; 
        height: 2px; 
        background: #d5d9d9; 
        border-radius: 1px; 
      }
      .price-slider-track { 
        position: absolute; 
        height: 100%; 
        background: #232f3e; 
        border-radius: 1px; 
      }
      .price-slider-thumb { 
        position: absolute; 
        width: 18px; 
        height: 18px; 
        background: linear-gradient(to bottom, #f7f8fa, #e7e9ec); 
        border: 1px solid #adb1b8; 
        border-radius: 50%; 
        top: 50%; 
        transform: translate(-50%, -50%); 
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(15,17,17,.15), 0 0 0 4px #fff;
      }
      .price-slider-thumb:hover { 
        background: linear-gradient(to bottom, #ffffff, #f0f2f2);
        box-shadow: 0 3px 8px rgba(15,17,17,.25), 0 0 0 4px #fff;
        border-color: #007185;
      }
      .price-slider-thumb:active {
        cursor: grabbing;
        background: linear-gradient(to bottom, #e7e9ec, #d5d9d9);
        box-shadow: 0 1px 3px rgba(15,17,17,.3) inset, 0 0 0 4px #fff;
        border-color: #007185;
      }
      .price-go-btn {
        background: #f0f2f2;
        border: 1px solid #888c8c;
        border-radius: 8px;
        color: #0f1111;
        font-size: 13px;
        font-weight: 400;
        padding: 4px 12px;
        cursor: pointer;
        white-space: nowrap;
        box-shadow: 0 2px 5px 0 rgba(213,217,217,.5);
      }
      .price-go-btn:hover {
        background: #e3e6e6;
        border-color: #007185;
      }
      .price-go-btn:active {
        background: #d5d9d9;
        box-shadow: 0 1px 2px rgba(15,17,17,.15) inset;
      }

      /* Mobile Filters Modal */
      .filters-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 200;
        display: none;
        align-items: flex-end;
      }
      .filters-modal.active { display: flex; }
      .filters-modal-content {
        background: #fff;
        width: 100%;
        max-height: 85vh;
        overflow-y: auto;
        border-radius: 12px 12px 0 0;
        animation: slideUp 0.3s ease;
        display: flex;
        flex-direction: column;
      }
      @keyframes slideUp {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
      }
      @keyframes scaleIn {
        from { transform: scale(0.98); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
      }
      .filters-modal-header {
        position: sticky;
        top: 0;
        background: #fff;
        border-bottom: 1px solid var(--border);
        padding: 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        z-index: 10;
      }
      .filters-modal-header h2 {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
      }
      .filters-modal-close {
        background: transparent;
        border: none;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .filters-modal-body {
        padding: 0;
        flex: 1;
        overflow: hidden; /* allow inner panes to scroll */
      }
      .filters-modal-footer {
        position: sticky;
        bottom: 0;
        background: #fff;
        border-top: 1px solid var(--border);
        padding: 12px 16px;
        display: flex;
        gap: 8px;
      }
      .filters-modal-footer .btn {
        flex: 1;
        padding: 12px;
        font-size: 14px;
      }

      /* Mobile Filters: two-pane split like Amazon */
      .filters-split { 
        display: grid; 
        grid-template-columns: 160px 1fr; 
        height: 100%; 
        max-height: calc(85vh - 112px); /* header+footer approx */
      }
      .filters-nav { 
        border-right: 1px solid var(--border); 
        background: #f7f7f7; 
        overflow-y: auto; 
        padding: 8px 0; 
      }
      .filters-nav .item { 
        display: block; 
        padding: 12px 12px; 
        font-weight: 700; 
        font-size: 14px; 
        color: #0f1111; 
        cursor: pointer; 
        border-left: 3px solid transparent; 
        user-select: none;
      }
      .filters-nav .item.active { 
        background: #fff; 
        border-left-color: #007185; 
      }
      .filters-content { 
        overflow-y: auto; 
        background: #fff; 
      }
      .filters-content .panel { 
        border: none; 
        border-bottom: 1px solid var(--border); 
        margin: 0; 
        padding: 16px; 
        display: none; /* hidden unless active */
      }
      .filters-content .panel.active { display: block; }
      .filters-content .panel .h { 
        font-size: 16px; 
        padding: 4px 0; 
        margin-bottom: 8px; 
      }

      /* Location Modal */
      .location-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(2px);
        z-index: 220;
        display: none;
        align-items: center; /* Center on desktop */
        justify-content: center;
      }
      .location-modal.active { display: flex; }
      .location-modal-content {
        background: #fff;
        width: min(520px, calc(100% - 48px)); /* Centered dialog width on desktop */
        max-height: 80vh;
        overflow-y: auto;
        border-radius: 12px; /* Rounded modal on desktop */
        box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        animation: scaleIn 0.2s ease;
        position: relative;
      }
      .location-modal-header {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        padding: 12px 16px 6px 16px;
        border-bottom: 0;
      }
      .location-modal-header .title {
        font-size: 20px;
        font-weight: 700;
      }
      /* Floating DONE button like Amazon */
      .location-modal .floating-done {
        position: absolute;
        top: 8px;
        right: 8px;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 999px;
        padding: 8px 14px;
        font-size: 12px;
        font-weight: 700;
        color: #111;
        cursor: pointer;
        line-height: 1;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      }
      .location-modal-body { padding: 12px 16px 16px 16px; }
      .location-modal-body .desc { color: #565959; font-size: 14px; margin-bottom: 8px; line-height: 1.4; }
      .location-modal-body .signin {
        width: 100%;
        background: linear-gradient(to bottom, #f7dfa5, #f0c14b);
        border: 1px solid #a88734;
        border-radius: 28px;
        color: #111;
        box-shadow: 0 2px 5px 0 rgba(213,217,217,.5);
        font-size: 16px;
        font-weight: 700;
        padding: 10px 16px;
        margin: 10px 0 14px 0;
        cursor: pointer;
      }
      .location-modal-body .signin:hover { background: linear-gradient(to bottom, #f5d78e, #edb933); }
      .location-modal-body .signin:active { background: linear-gradient(to bottom, #f0c14b, #e1a800); box-shadow: 0 1px 3px rgba(0,0,0,.15) inset; }
      .location-modal-body .divider { height: 1px; background: #e7e9ec; margin: 14px 0; }
      .location-modal-body .actions { display: grid; gap: 0; }
      .location-modal-body .row {
        display: flex;
        align-items: center;
        gap: 10px;
        background: transparent;
        border: 0;
        padding: 12px 0;
        font-size: 15px;
        color: #0f1111;
        cursor: pointer;
        text-align: left;
        border-bottom: 1px solid #e7e9ec;
      }
      .location-modal-body .row:last-child { border-bottom: 0; }
      .location-modal-body .row .ico { width: 28px; height: 28px; border-radius: 999px; background: #f3f4f6; color: #0f1111; display: inline-flex; align-items: center; justify-content: center; }
      .location-modal-body .row .ico svg { width: 16px; height: 16px; display: block; stroke-width: 2; }
      
      /* Mobile toolbar filters button */
      .mobile-filters-btn {
        display: none;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 20px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        position: relative;
      }
      .mobile-filters-btn .badge {
        position: absolute;
        top: -6px;
        right: -6px;
        background: #c7511f;
        color: #fff;
        border-radius: 999px;
        padding: 2px 6px;
        font-size: 11px;
        font-weight: 700;
        line-height: 1;
        min-width: 18px;
        text-align: center;
        display: none;
      }
      .mobile-filters-btn .badge.active {
        display: block;
      }
      
      /* Mobile delivery banner (Amazon-like) */
      .mobile-delivery {
        display: none;
        background: #e6f1f8; /* subtle light-blue (overridden on mobile) */
        padding: 10px 12px;
        font-size: 13px;
        align-items: center;
        gap: 8px;
      }
      .mobile-delivery .icon {
        display: inline-block;
        width: 18px;
        height: 18px;
        line-height: 0;
        color: #0f1111;
      }
      
      /* Simple responsiveness */
      @media (max-width: 1400px) { .grid { grid-template-columns: repeat(3, 1fr); } }
      @media (max-width: 1100px) { .grid { grid-template-columns: repeat(2, 1fr); } }
      @media (max-width: 1024px) { 
        /* Hide basket on tablet and mobile */
        .basket {
          display: none !important;
        }
        /* Let search bar claim freed space and push cart to the edge */
        .topbar {
          grid-template-columns: 130px 110px 1fr 200px auto;
        }
        .cart-nav { justify-self: end; }
        .cart-nav .label {
          display: none;
        }
        body.basket-open .topbar,
        body.basket-open .toolbar,
        body.basket-open .shell {
          margin-right: 0;
        }
      }
      @media (max-width: 900px) { 
        .shell { grid-template-columns: 1fr; }
        .filters { display: none !important; }
      }
      
      /* Mobile Styles */
      @media (max-width: 768px) {
        :root {
          --topbar-h: 110px;
        }
        
        /* Location modal bottom sheet behavior on mobile */
        .location-modal { align-items: flex-end; }
        /* Fixed sheet height and side insets to match ruler expectation in tests */
        .location-modal-content{ height: 300px; max-height: 300px; width: calc(100% - 24px); margin: 0 12px 0; overflow: visible; border-radius: 22px 22px 0 0; box-shadow: 0 -6px 24px rgba(0,0,0,0.2); animation: slideUp 0.25s ease; }
        .location-modal-header { padding: 14px 12px 2px; }
        .location-modal-header .title{ font-size: 20px; line-height: 1.2; letter-spacing: -0.2px; }
        .location-modal-body{ padding: 6px 12px 10px; max-height: 230px; overflow-y: auto; }
        .location-modal-body .desc{ font-size: 14px; line-height: 1.5; }
        .location-modal-body .signin{ font-size: 16px; padding: 9px 12px; margin: 10px 0 10px; }
        .location-modal-body .divider{ display: none; }
        .location-modal-body .row{ font-size: 14px; padding: 10px 0; }
        .location-modal-body .row .ico{ width: 22px; height: 22px; }
        .location-modal-body .row .ico svg{ width: 14px; height: 14px; }
        .location-modal.active .floating-done{ position: absolute; top: -40px; right: 16px; z-index: 1000; background: #fff; font-size: 13px; border: 1px solid #e5e7eb; box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        
        /* Prevent any horizontal overflow on mobile */
        html, body { overflow-x: hidden; }
        
        /* Ensure containers and cards never exceed viewport width */
        .shell, .main, .grid, .product { max-width: 100%; }
        .product { width: 100%; }
        .main, .grid, .product { min-width: 0; }
        .grid { width: 100%; }
        
        /* Allow long names/prices to wrap safely */
        .p-title { word-break: break-word; }
        .price { flex-wrap: wrap; }
        
        /* Mobile topbar - stacked layout */
        .topbar {
          grid-template-columns: auto auto 1fr auto; /* row 1: burger | logo | sign in | basket */
          grid-template-rows: auto auto auto;         /* rows: 1 header icons, 2 search, 3 delivery */
          height: auto;
          padding: 0 8px;
          gap: 8px;
          /* Remove vertical space between search and delivery row on mobile while keeping column spacing */
          column-gap: 8px;
          row-gap: 0;
          align-items: center;
        }
        /* Hide desktop-only bits */
        .nav-right { display: none; }
        .logo { display: inline-block; grid-row: 1; grid-column: 2; font-size: 27px; padding: 2px 6px; }
        .logo .tld { font-size: 18px; }
        /* Row 1 items */
        .burger {
          display: inline-flex;
          grid-row: 1; grid-column: 1;
          align-items: center; justify-content: center;
          width: 44px; height: 44px;
          border: 0;
          border-radius: 4px;
          background: transparent; color: #fff;
          font-size: 34px; line-height: 1; cursor: pointer;
          padding: 0;
        }
        .mobile-signin {
          display: inline-flex;
          grid-row: 1; grid-column: 3;
          align-items: center; justify-content: center; justify-self: end;
          gap: 6px; color: #fff; font-size: 14px; font-weight: 600;
        }
        .mobile-signin .mi { font-size: 18px; opacity: .95; }
        .cart-nav { grid-row: 1; grid-column: 4; }
        .location-picker {
          display: none;
        }
        .searchbar {
          grid-row: 2;
          grid-column: 1 / span 4;
        }
        .searchbar select {
          display: none; /* No category filter on mobile */
        }
        .search input {
          font-size: 14px;
          padding: 10px 8px; /* increase height on mobile */
        }
        .search-btn {
          padding: 10px 12px; /* increase height on mobile */
        }
        .search-btn .icon {
          font-size: 20px;
        }
        .nav-right {
          position: absolute;
          top: 8px;
          right: 8px;
          gap: 4px;
        }
        .nav-item {
          display: none;
        }
        .lang-selector {
          padding: 4px 6px;
        }
        .lang-selector .flag {
          font-size: 16px;
        }
        .lang-selector .lang {
          font-size: 12px;
        }
        .cart-nav {
          padding: 4px 6px;
        }
        .cart-nav .label {
          display: none;
        }
        .cart-nav .cart-icon {
          width: 32px;
          height: 24px;
          margin-bottom: 0;
          margin-left: -10px;
        }
        .cart-nav .badge-top {
          top: 0;
          left: 10px;
          font-size: 12px;
          line-height: 16px;
          min-width: 16px;
          padding: 0 4px;
        }
        
        /* Mobile delivery control ‚Äî compact inline like Amazon */
        .mobile-delivery {
          display: flex;
          grid-row: 3; grid-column: 1 / span 4;
          background: #233142; /* Amazon-like secondary header strip */
          color: #fff;
          padding: 10px 12px;
          gap: 8px;
          align-items: center;
          cursor: pointer;
          border-top: 1px solid rgba(255,255,255,0.08);
          /* stretch to full width of header (negate topbar padding) */
          margin-left: -8px;
          margin-right: -8px;
        }
        .mobile-delivery .icon { line-height: 0; display: inline-flex; }
        .mobile-delivery .icon svg { width: 18px; height: 18px; stroke: #fff; }
        .mobile-delivery span#mobileDeliveryLabel { font-size: 14px; font-weight: 500; }
        .mobile-delivery .chev { margin-left: 6px; display: inline-flex; color: #fff; font-size: 16px; line-height: 1; }
        
        /* Mobile toolbar */
        .toolbar {
          display: none; /* hidden on mobile ‚Äî use .mobile-filterbar instead */
          align-items: center;
          justify-content: flex-end;
          gap: 8px;
          padding: 0;
        }
        .toolbar .left { display: none; }
        .toolbar .right { display: flex; align-items: center; gap: 8px; }
        .mobile-filters-btn { display: inline-flex; }
        .toolbar .sort-label { display: none; }
        .toolbar #sort { display: none; }

        /* Mobile slim filter bar (below header) */
        .mobile-filterbar {
          display: flex;
          align-items: center;
          gap: 8px;
          background: #fff;
          padding: 6px 10px;
          border-bottom: 1px solid var(--border);
          flex-wrap: nowrap; /* keep controls on a single line */
        }
        .mobile-filterbar .mf-scroll {
          display: flex;
          gap: 8px;
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
          scrollbar-width: none;
          flex: 1 1 auto;
          padding-bottom: 2px; /* avoid cut-off shadows */
          min-width: 0; /* allow this flex item to shrink so the right control fits */
        }
        .mobile-filterbar .mf-scroll::-webkit-scrollbar { display: none; }
        .mobile-filterbar .mf-chip {
          border: 1px solid #d5d9d9;
          background: #f0f2f2;
          border-radius: 999px;
          padding: 5px 10px;
          font-size: 12px;
          color: #0f1111;
          cursor: pointer;
          line-height: 1;
          white-space: nowrap;
          flex: 0 0 auto;
        }
        .mobile-filterbar .mf-chip:hover { background: #e3e6e6; }
        .mobile-filterbar .mf-chip.active { background: #111; color: #fff; border-color: #111; }
        .mobile-filterbar .mf-divider {
          width: 1px;
          align-self: stretch;
          background: #e7e9ec;
          margin: 0 2px 0 4px;
        }
        .mobile-filterbar .mf-right {
          margin-left: auto;
          display: inline-flex;
          align-items: center;
          gap: 4px;
          color: #0f1111;
          cursor: pointer;
          font-size: 13px;
          flex: 0 0 auto; /* prevent shrinking */
          white-space: nowrap; /* keep label and arrow together */
        }
        .mobile-filterbar .mf-right svg { width: 12px; height: 12px; }
        
        /* Single column grid for mobile */
        .grid {
          grid-template-columns: minmax(0, 1fr) !important;
          gap: 8px;
        }

        
        /* Mobile product cards - larger for 2 per screen */
        .product {
          padding: 12px;
        }
        .thumb {
          height: 210px;
        }
        .p-title {
          font-size: 13px;
          min-height: 40px;
          -webkit-line-clamp: 2;
          line-clamp: 2;
        }
        .p-cta {
          flex-direction: column;
        }
        .p-cta .btn {
          width: 100%;
        }
        /* Single primary CTA on mobile */
        .p-cta .btn:not(.add) {
          display: none;
        }
        .price {
          margin: 2px 0 4px 0;
        }
        .price .whole {
          font-size: 19px;
        }

        /* Rework product card to Amazon-like list layout: left image, right content */
        .product {
          display: grid;
          grid-template-columns: 140px 1fr;
          grid-auto-rows: min-content;
          column-gap: 12px;
          align-items: start;
        }
        .product > .thumb {
          grid-column: 1;
          grid-row: 1 / span 10; /* span enough rows to cover content block */
          width: 140px;
          height: 140px;
        }
        .product > *:not(.thumb) {
          grid-column: 2;
        }
        
        /* Hide suggestions dropdown on mobile */
        .sugg {
          max-width: 100%;
          width: calc(100% - 20px);
          left: 10px;
          transform: none;
          top: calc(var(--topbar-h) + 52px);
        }
        
        /* Mobile browsing history carousel */
        #browsing-history {
          margin-top: 24px !important;
          padding: 0 !important;
          border: none !important;
        }
        #browsing-history .h {
          padding: 0 12px;
          margin-bottom: 12px !important;
          font-size: 18px;
        }
        #browsing-history .carousel-wrapper {
          overflow-x: auto;
          overflow-y: hidden;
          -webkit-overflow-scrolling: touch;
          scrollbar-width: none;
          padding: 0 12px;
        }
        #browsing-history .carousel-wrapper::-webkit-scrollbar {
          display: none;
        }
        #browsing-history .carousel {
          display: flex;
          gap: 12px;
          grid-template-columns: none;
        }
        #browsing-history .carousel .product {
          min-width: 160px;
          flex-shrink: 0;
        }
        #browsing-history .carousel .thumb {
          height: 160px;
        }
        #browsing-history .carousel .p-title {
          font-size: 12px;
          min-height: 32px;
          -webkit-line-clamp: 2;
          line-clamp: 2;
        }
        #browsing-history .carousel .small {
          font-size: 11px;
        }
        #browsing-history .carousel .price .whole {
          font-size: 16px;
        }
        .carousel-nav {
          display: none;
        }
        #carouselPage {
          display: none;
        }
        
        /* Mobile filters modal styling */
        .filters-modal-content .panel {
          border: none;
          border-radius: 0;
          border-bottom: 1px solid var(--border);
          margin: 0;
          padding: 16px;
        }
        .filters-modal-content .panel .h {
          font-size: 16px;
          padding: 4px 0;
        }
        /* Category is excluded in JS for mobile; do not hide the first panel generically */
        .filters-modal-body .link {
          margin-top: 8px;
          display: inline-block;
        }
        
        /* Hide pager on mobile */
        .pager {
          display: none;
        }
        
        /* Shell padding */
        .shell {
          padding: 0 12px 12px 12px;
        }
        
        /* Main */
        .main {
          margin-top: 8px;
        }
        
        /* Active pills on mobile */
        .active-pills {
          display: none; /* Hide on mobile since filters are in modal */
        }
        
        /* Related searches on mobile */
        #relatedPanel {
          margin-top: 16px !important;
          padding: 12px !important;
        }
        #relatedPanel .h {
          font-size: 16px;
          margin-bottom: 8px;
        }
        #relatedPanel .chips {
          gap: 8px;
        }
        #relatedPanel .chip {
          font-size: 12px;
          padding: 6px 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="topbar">
      <button class="burger" id="burgerBtn" aria-label="Menu">‚â°</button>
      <div class="mobile-signin" id="mobileSignin"><span class="mi">üë§</span><span>Sign in ‚Ä∫</span></div>
      <div class="logo">health<span class="tld">.ee</span></div>
      
      <div class="location-picker" id="openLocationDesktop">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 21c-4.6-4.9-7-8.2-7-11.2a7 7 0 1 1 14 0c0 3-2.4 6.3-7 11.2z"></path>
            <circle cx="12" cy="10" r="3"></circle>
          </svg>
        </span>
        <div class="text">
          <div class="label">Deliver to</div>
          <div class="city">Estonia</div>
        </div>
      </div>
      
      <div class="searchbar">
        <select id="catSelect">
          <option>All</option>
          <option>Protein</option>
          <option>Creatine</option>
          <option>Pre-Workout</option>
          <option>Amino Acids</option>
          <option>Vitamins & Health</option>
        </select>
        <div class="search">
          <input id="q" placeholder="Search protein, creatine, vanilla‚Ä¶" autocomplete="off" />
        </div>
        <button class="search-btn" id="go">
          <span class="icon">üîç</span>
        </button>
      </div>
      
      <div class="nav-right">
        <div class="lang-selector">
          <span class="flag">üá™üá™</span>
          <span class="lang" id="currentLang">EN</span>
          <span> ‚åµ</span>
          <div class="lang-dropdown">
            <div class="lang-option active" data-lang="EN">English</div>
            <div class="lang-option" data-lang="RU">–†—É—Å—Å–∫–∏–π</div>
            <div class="lang-option" data-lang="EE">Eesti</div>
          </div>
        </div>
        
        <div class="nav-item">
          <div class="top">Hello, sign in</div>
          <div class="bottom">Account & Lists ‚åµ</div>
          <div class="account-dropdown">
            <a href="#" class="signin-btn">Sign in</a>
            <div class="new-customer">New customer? <a href="#">Start here.</a></div>
            <div class="dropdown-header">Your Account</div>
            <div class="dropdown-section">
              <a href="#" class="dropdown-item">Your Account</a>
              <a href="#" class="dropdown-item">Your Orders</a>
              <a href="#" class="dropdown-item">Your Wish List</a>
              <a href="#" class="dropdown-item">Your Recommendations</a>
              <a href="#" class="dropdown-item">Your Subscribe & Save Items</a>
              <a href="#" class="dropdown-item">Memberships & Subscriptions</a>
            </div>
          </div>
        </div>
      </div>
      
      <div class="cart-nav">
        <span class="badge-top" id="cartBadge">0</span>
        <div class="cart-icon">
          <svg viewBox="0 0 40 32" xmlns="http://www.w3.org/2000/svg">
            <path d="M 8 8 L 12 8 L 16 24 L 34 24 M 16 24 L 18 28 L 32 28" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="20" cy="30" r="1.5" fill="#fff"/>
            <circle cx="30" cy="30" r="1.5" fill="#fff"/>
          </svg>
        </div>
        <div class="label">Shopping-<br>Basket</div>
      </div>

      <!-- Mobile Delivery Control (row 3 inside header) -->
      <div class="mobile-delivery" id="openLocation">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 21c-4.6-4.9-7-8.2-7-11.2a7 7 0 1 1 14 0c0 3-2.4 6.3-7 11.2z"></path>
            <circle cx="12" cy="10" r="3"></circle>
          </svg>
        </span>
        <span id="mobileDeliveryLabel">Deliver to Estonia ‚åµ</span>
        <span class="chev" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"></path></svg>
        </span>
      </div>
    </div>

    <!-- Suggestions -->
    <div class="sugg" id="sugg" style="display:none;">
      <div class="box" id="suggBox"></div>
    </div>

    

     <!-- Mobile slim filter bar -->
     <div class="mobile-filterbar" id="mobileFilterbar">
       <div class="mf-scroll">
         <button class="mf-chip" data-range="0-20">Up to 20 EUR</button>
         <button class="mf-chip" data-range="20-30">20 - 30 EUR</button>
         <button class="mf-chip" data-range="30-35">30 - 35 EUR</button>
         <button class="mf-chip" data-range="35-">Over 35 EUR</button>
       </div>
       <div class="mf-divider"></div>
       <span class="mf-right" id="openFilters2">Filters ‚åµ</span>
     </div>

    <!-- Toolbar - full width -->
    <div class="toolbar">
      <div class="left">
        <div id="count">0 results</div>
        <div class="small muted meta" id="meta">Fast shipping ‚Ä¢ Free returns</div>
      </div>
      <div class="right">
        <button class="mobile-filters-btn" id="openFilters">
          <span>‚ò∞</span>
          <span>Filters ‚åµ</span>
          <span class="badge" id="filtersBadge">0</span>
        </button>
        <span class="sort-label">Sort by:</span>
        <select id="sort">
          <option value="relevance">Featured</option>
          <option value="price-asc">Price: Low to High</option>
          <option value="price-desc">Price: High to Low</option>
          <option value="rating-desc">Avg. Customer Review</option>
          <option value="newest">Newest</option>
        </select>
      </div>
    </div>

    <div class="shell">
      <!-- FILTERS -->
      <aside class="filters">
        <div class="panel">
          <div class="h">
            <div>Refine</div>
            <button class="link" id="clearAll">Clear all</button>
          </div>
          <div class="chips" id="activePills"></div>
        </div>

        <div class="panel" data-key="category">
          <div class="h"><span>Category</span></div>
          <div id="fCategory"></div>
        </div>
        <div class="panel" data-key="brand">
          <div class="h"><span>Brand</span></div>
          <div id="fBrand"></div>
          <button class="link" id="brandMore">Show more</button>
        </div>
        <div class="panel" data-key="price">
          <div class="h"><span>Price</span></div>
          <div>
            <div class="price-range">
              <div class="price-display" id="priceDisplay">‚Ç¨4‚Äì‚Ç¨390+</div>
              <div class="price-slider-container">
                <div class="price-slider-wrapper">
                  <div class="price-slider" id="priceSlider">
                    <div class="price-slider-track" id="priceTrack"></div>
                    <div class="price-slider-thumb" id="priceThumbMin" data-thumb="min"></div>
                    <div class="price-slider-thumb" id="priceThumbMax" data-thumb="max"></div>
                  </div>
                </div>
                <button class="price-go-btn" id="priceGo">Go</button>
              </div>
            </div>
            <div class="chips">
              <div class="chip" data-val="0-20">‚Ç¨0‚Äì20</div>
              <div class="chip" data-val="20-40">‚Ç¨20‚Äì40</div>
              <div class="chip" data-val="40-80">‚Ç¨40‚Äì80</div>
              <div class="chip" data-val="80-">‚Ç¨80+</div>
            </div>
          </div>
        </div>
        <div class="panel" data-key="flavour">
          <div class="h"><span>Flavour</span></div>
          <div id="fFlavour"></div>
        </div>
        <div class="panel" data-key="diet">
          <div class="h"><span>Dietary</span></div>
          <div id="fDiet"></div>
        </div>
        <div class="panel" data-key="form">
          <div class="h"><span>Item Form</span></div>
          <div id="fForm"></div>
          <button class="link" id="formMore">See Less</button>
        </div>
        <div class="panel" data-key="container">
          <div class="h"><span>Container Type</span></div>
          <div id="fContainer"></div>
        </div>
        <div class="panel" data-key="size">
          <div class="h"><span>Size</span></div>
          <div id="fSize"></div>
        </div>
        <div class="panel" data-key="availability">
          <div class="h"><span>Availability</span></div>
          <div id="fAvailability">
            <button class="chip" id="availToggle" type="button">Include Out of Stock</button>
          </div>
        </div>
      </aside>

      <!-- MAIN RESULTS -->
      <main class="main">
        <div class="active-pills" id="pills"></div>
        <div class="grid" id="grid"></div>
        <div class="pager" id="pager"></div>
        <div class="panel" id="relatedPanel" style="display:none; margin-top: 8px;">
          <div class="h">Related searches</div>
          <div class="chips" id="relatedChips"></div>
        </div>
        
        <!-- Inspired by browsing history -->
        <div class="panel" id="browsing-history" style="margin-top: 16px;">
          <div class="h" style="margin-bottom: 12px;">Inspired by your browsing history</div>
          <div class="carousel-wrapper">
            <button class="carousel-nav prev" id="carouselPrev" disabled>‚Äπ</button>
            <div class="carousel" id="historyCarousel"></div>
            <button class="carousel-nav next" id="carouselNext">‚Ä∫</button>
          </div>
          <div style="text-align: right; margin-top: 8px;">
            <span style="font-size: 12px; color: var(--muted);" id="carouselPage">Page 1 of 2</span>
          </div>
        </div>
      </main>

      <!-- SIDE BASKET - Full height popup -->
      <aside class="basket" id="basketPanel">
        <button class="close-btn" id="closeBasket" aria-label="Close basket">‚úï</button>
        <div class="panel summary">
          <div class="subhead">Subtotal</div>
          <div class="subtotal"><span class="price" id="subtotal" aria-live="polite">‚Ç¨0.00</span></div>
          <div class="free-msg" id="freeMsg">Add <b>‚Ç¨0.00</b> of eligible items to your order to qualify for <b>FREE</b> Delivery.</div>
          <div class="free-link"><a href="#">Delivery Details</a></div>
          <button class="go" id="goBasket">Go to Basket</button>
        </div>
        <div class="panel items">
          <div id="basketItems">
            <div class="muted" style="padding: 10px 0; text-align: center; font-size: 10px;">No items yet</div>
          </div>
        </div>
      </aside>
    </div>

    <!-- Mobile Filters Modal -->
    <div class="filters-modal" id="filtersModal">
      <div class="filters-modal-content">
        <div class="filters-modal-header">
          <h2>Filters ‚åµ</h2>
          <button class="filters-modal-close" id="closeFilters">‚úï</button>
        </div>
        <div class="filters-modal-body" id="filtersModalBody">
          <!-- Filters content will be cloned here -->
        </div>
        <div class="filters-modal-footer">
          <button class="btn" id="clearFilters">Clear all</button>
          <button class="btn primary" id="applyFilters">Apply</button>
        </div>
      </div>
    </div>

    <!-- Location Modal -->
    <div class="location-modal" id="locationModal" aria-hidden="true">
      <div class="location-modal-content" role="dialog" aria-modal="true" aria-labelledby="locTitle">
        <button class="floating-done" id="closeLocationTop">DONE</button>
        <div class="location-modal-header">
          <div class="title" id="locTitle">Choose your location</div>
        </div>
        <div class="location-modal-body">
          <div class="desc">Delivery options and delivery speeds may vary for different locations</div>
          <button class="signin">Sign in to see your addresses</button>
          <div class="divider"></div>
          <div class="actions">
            <button class="row"><span class="ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 21c-4.6-4.9-7-8.2-7-11.2a7 7 0 1 1 14 0c0 3-2.4 6.3-7 11.2z"></path><circle cx="12" cy="10" r="3"></circle></svg></span>Enter a postal code</button>
            <button class="row"><span class="ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v2"></path><path d="M12 17v2"></path><path d="M5 12h2"></path><path d="M17 12h2"></path><circle cx="12" cy="12" r="4"></circle></svg></span>Use my current location</button>
            <button class="row" id="deliverOutsideBtn"><span class="ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"></circle></svg></span>Deliver outside Estonia</button>
          </div>
        </div>
      </div>
    </div>

    <div id="ariaLive" aria-live="polite" style="position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden;"></div>
    <script src="api.js"></script>
    <script>
      // Step 2: Minimal real search integration (initial render only)
      const REAL_PAGE_SIZE = 32;
      const realState = { q: '', page: 1, size: REAL_PAGE_SIZE, sort: null, filters: { in_stock: true } };
      const realProductCache = new Map(); // id -> product from API

      function fmtPriceEu(n, cents){
        const v = (typeof n === 'number' && !isNaN(n)) ? n : (typeof cents === 'number' ? (cents/100) : null);
        if (v == null) return null;
        const s = v.toFixed(2);
        const i = s.indexOf('.');
        return { whole: s.slice(0, i), fraction: s.slice(i+1) };
      }

      function buildProductCard(p){
        const priceParts = fmtPriceEu(p.price, p.price_cents);
        const brand = p.brand_name || p.brand_slug || '';
        const cat = Array.isArray(p.categories_names) && p.categories_names.length ? p.categories_names[0] : '';
        const title = (p.display_title && p.display_title.trim()) ? p.display_title : (p.name || '');
        const variants = ((p.dynamic_attrs && Array.isArray(p.dynamic_attrs.flavors)) ? p.dynamic_attrs.flavors : []).slice(0,3).map(f=>`<span class="chip small">${esc(f)}</span>`).join(' ');
        const allFlavors = (p.dynamic_attrs && Array.isArray(p.dynamic_attrs.flavors)) ? p.dynamic_attrs.flavors : [];
        const more = allFlavors.length>3 ? `<span class="chip small">+${allFlavors.length-3} more</span>` : '';
        const deliveryStr = deliveryDatePlusFour();
        const firstImg = Array.isArray(p.images) && p.images.length ? p.images[0] : null;
        return (
          `<div class="product" data-id="${esc(p.id)}">`
            + `<div class="thumb">${firstImg?`<img src="${esc(firstImg)}" alt="" style="max-width:100%;max-height:100%;object-fit:contain;">`:'IMG'}</div>`
            + `<div class="p-title">${esc(title)}</div>`
            + `<div class="small"><span class="p-brand">${esc(brand)}</span>${cat?` ‚Ä¢ <span>${esc(cat)}</span>`:''}</div>`
            + `<div class="small"><span class="p-stars">${p.rating ? stars(p.rating) : ''}</span> <span class="muted">(${p.review_count||0})</span></div>`
            + (priceParts ? `<div class="price"><span class="currency">‚Ç¨</span><span class="whole">${priceParts.whole}</span><span class="fraction">${priceParts.fraction}</span></div>` : '')
            + (p.in_stock ? `<div class="small">FREE delivery <b>${deliveryStr}</b> if you spend ‚Ç¨59</div>` : `<div class="small muted">Out of stock</div>`)
            + `<div class="small">${variants} ${more}</div>`
            + `<div class="p-cta">`
              + `<button class="btn small add">Add to Basket</button>`
            + `</div>`
          + `</div>`
        );
      }

      async function fetchRealResults(){
        try {
          const resp = await (window.apiV3 && window.apiV3.searchProducts ? window.apiV3.searchProducts(realState.q, { page: realState.page, size: realState.size, filters: realState.filters, sort: realState.sort }) : Promise.resolve(null));
          return resp;
        } catch(e){
          console.error('Real search failed', e);
          return null;
        }
      }

      function renderReal(resp){
        if (!resp || !Array.isArray(resp.items)) return;
        const items = resp.items;
        try { items.forEach(p => { if (p && p.id != null) realProductCache.set(String(p.id), p); }); } catch(e){}
        const total = typeof resp.total === 'number' ? resp.total : 0;
        const grid = document.getElementById('grid');
        if (grid) grid.innerHTML = items.map(buildProductCard).join('');
        const count = document.getElementById('count');
        if (count) count.textContent = `${total} results${realState.q?` for ${esc(realState.q)}`:''}`;
        // basic pager
        const pager = document.getElementById('pager');
        if (pager){
          const totalPages = Math.max(1, Math.ceil(total / realState.size));
          pager.innerHTML = '';
          if (totalPages>1){
            for(let p=1; p<=totalPages && p<=10; p++){ // cap visible buttons to 10
              const b = document.createElement('button');
              b.className = 'btn small' + (p===realState.page?' current':'');
              b.textContent = String(p);
              b.addEventListener('click', async ()=>{
                realState.page = p;
                window.scrollTo({ top: 0, behavior: 'smooth' });
                const r = await fetchRealResults();
                renderReal(r);
              });
              pager.appendChild(b);
            }
            const next = document.createElement('button');
            next.className = 'btn small';
            next.textContent = 'Next >';
            next.addEventListener('click', async ()=>{
              const totalPages2 = Math.max(1, Math.ceil(total / realState.size));
              if (realState.page < totalPages2){
                realState.page++;
                window.scrollTo({ top: 0, behavior: 'smooth' });
                const r = await fetchRealResults();
                renderReal(r);
              }
            });
            pager.appendChild(next);
          }
        }
        // wire add buttons to basket UI (real products)
        $$('#grid .product .add').forEach(btn => btn.addEventListener('click', e => {
          const id = String(e.target.closest('.product').getAttribute('data-id'));
          try {
            if (!state || !state.basket) return;
            state.basket.set(id, (state.basket.get(id)||0)+1);
            renderBasketReal();
            openBasket();
            const totalQty = Array.from(state.basket.values()).reduce((s,n)=>s+n,0);
            $('#ariaLive').textContent = `Added to basket. Basket ${totalQty} items.`;
          } catch(err){ /* noop */ }
        }));
      }

      async function initRealMode(){
        const resp = await fetchRealResults();
        if (resp) renderReal(resp);
      }

      function renderBasketReal(){
        try {
          const entries = Array.from(state.basket.entries());
          const items = entries.map(([id,qty])=>{
            const p = realProductCache.get(String(id));
            return p ? { p, qty } : null;
          }).filter(Boolean);
          const host = document.getElementById('basketItems');
          if (host){
            if (!items.length){
              host.innerHTML = '<div class="muted" style="padding: 10px 0; text-align: center; font-size: 10px;">No items yet</div>';
            } else {
              host.innerHTML = items.map(({p,qty}) => {
                const price = (typeof p.price === 'number') ? p.price : (typeof p.price_cents === 'number' ? p.price_cents/100 : 0);
                const firstImg = Array.isArray(p.images) && p.images.length ? p.images[0] : null;
                return (
                  `<div class="item-block" data-id="${esc(p.id)}">`
                  + `<div class="pimg">${firstImg?`<img src=\"${esc(firstImg)}\" alt=\"\" style=\"max-width:100%;max-height:100%;object-fit:contain;\">`:'IMG'}</div>`
                  + `<div class="price"><span class="val">‚Ç¨${(price||0).toFixed(2)}</span></div>`
                  + `<div class="qty-ctrl">`
                    + `<button class="trash" title="Remove">üóë</button>`
                    + `<span class="count">${qty}</span>`
                    + `<button class="plus" title="Add">+</button>`
                  + `</div>`
                  + `</div>`
                );
              }).join('');
              $$('#basketItems .item-block .plus').forEach(b => b.addEventListener('click', (e)=>{
                const id = String(e.target.closest('.item-block').getAttribute('data-id'));
                state.basket.set(id, (state.basket.get(id)||0)+1);
                renderBasketReal();
              }));
              $$('#basketItems .item-block .trash').forEach(b => b.addEventListener('click', (e)=>{
                const id = String(e.target.closest('.item-block').getAttribute('data-id'));
                state.basket.delete(id);
                renderBasketReal();
              }));
            }
          }
          const subtotal = items.reduce((s,{p,qty})=>{
            const price = (typeof p.price === 'number') ? p.price : (typeof p.price_cents === 'number' ? p.price_cents/100 : 0);
            return s + (price||0) * qty;
          },0);
          const subtotalEl = document.getElementById('subtotal'); if (subtotalEl) subtotalEl.textContent = `‚Ç¨${subtotal.toFixed(2)}`;
          const qty = entries.reduce((s,[_id,q])=>s+q,0);
          const badge = document.getElementById('cartBadge'); if (badge) badge.textContent = String(qty);
          const THRESH = 35;
          const freeMsg = document.getElementById('freeMsg');
          if (freeMsg){
            const diff = THRESH - subtotal;
            freeMsg.innerHTML = diff > 0 ? `Add <b>‚Ç¨${diff.toFixed(2)}</b> of eligible items to qualify for <b>FREE</b> Delivery.` : `Your order qualifies for <b>FREE</b> Delivery.`;
          }
        } catch(e){ /* noop */ }
      }

      function assembleRealSort(val){
        if (val === 'price-asc') return ["price:asc"];
        if (val === 'price-desc') return ["price:desc"];
        if (val === 'rating-desc') return ["rating:desc","review_count:desc"];
        // 'relevance' and 'newest' fall back to default (no sort)
        return null;
      }

      function wireRealSearchInput(){
        const goBtn = document.getElementById('go');
        const qEl = document.getElementById('q');
        if (goBtn){
          goBtn.addEventListener('click', async (e)=>{
            e.preventDefault();
            e.stopPropagation();
            realState.q = (qEl && qEl.value ? qEl.value.trim() : '');
            realState.page = 1;
            const r = await fetchRealResults();
            if (r) renderReal(r);
          }, true);
        }
        if (qEl){
          qEl.addEventListener('keydown', async (e)=>{
            if (e.key === 'Enter'){
              e.preventDefault();
              e.stopPropagation();
              realState.q = (qEl.value || '').trim();
              realState.page = 1;
              const r = await fetchRealResults();
              if (r) renderReal(r);
            }
          }, true);
        }
      }

      function wireRealSorting(){
        const sortEl = document.getElementById('sort');
        if (!sortEl) return;
        sortEl.addEventListener('change', async (e)=>{
          e.preventDefault();
          e.stopPropagation();
          const val = sortEl.value;
          realState.sort = assembleRealSort(val);
          realState.page = 1;
          const r = await fetchRealResults();
          if (r) renderReal(r);
        }, true);
      }

      function wireRealAvailability(){
        const avail = document.getElementById('availToggle');
        if (!avail) return;
        avail.addEventListener('click', async (e)=>{
          // capture and prevent mock render
          e.preventDefault();
          e.stopPropagation();
          // Toggle include OOS: when active include both true and false
          const isActive = avail.classList.contains('active');
          if (!isActive){
            // will become active -> include OOS
            realState.filters.in_stock = [true, false];
          } else {
            // will become inactive -> only in-stock
            realState.filters.in_stock = true;
          }
          realState.page = 1;
          const r = await fetchRealResults();
          if (r) renderReal(r);
        }, true);
      }
      // Minimal dataset for desktop wireframe
      const COUNTRY = 'Estonia';
      // Freeze dates to stabilize visual snapshots (keeps lengths identical across runs)
      const NOW_MS = Date.UTC(2024, 9, 16); // 2024-10-16 00:00:00Z
      const CATEGORIES = ['Protein','Creatine','Pre-Workout','Amino Acids','Vitamins & Health'];
      const BRANDS = ['OptiMax','PureLift','Volt Labs','NordicWell','GreenFuel','IronDust','BioEdge','PeakForm'];
      const FLAVOURS = ['Vanilla','Chocolate','Strawberry','Cookies & Cream','Banana','Peanut Butter','Salted Caramel','Unflavoured'];
      const DIETS = ['Vegan','Vegetarian','Gluten-free','Keto-friendly'];
      const CONTAINERS = ['Canister','Bag','Bottle','Jar','Box','Tub'];

      let seed = 42; function rng(){ seed ^= seed<<13; seed ^= seed>>>17; seed ^= seed<<5; return (seed>>>0)/4294967296; }
      function pick(arr){ return arr[Math.floor(rng()*arr.length)]; }
      function pickMany(arr,n){ const a=arr.slice(),o=[]; n=Math.min(n,a.length); for(let i=0;i<n;i++){ o.push(a.splice(Math.floor(rng()*a.length),1)[0]); } return o; }

      const FORMS = { 'Protein':['Powder'], 'Creatine':['Powder','Capsule'], 'Pre-Workout':['Powder'], 'Amino Acids':['Powder','Capsule','Tablet'], 'Vitamins & Health':['Capsule','Tablet','Softgel'] };
      const SIZES = { 'Protein':['900g','1kg','2kg'], 'Creatine':['300g','500g','1kg'], 'Pre-Workout':['20 servings','30 servings'], 'Amino Acids':['250g','300g'], 'Vitamins & Health':['60 caps','90 caps','120 caps'] };
      const DATA = Array.from({length: 72}).map((_,i)=>{
        const cat = pick(CATEGORIES);
        const brand = pick(BRANDS);
        const flavours = pickMany(FLAVOURS, 1 + Math.floor(rng()*3));
        const diet = pickMany(DIETS, Math.floor(rng()*3));
        const price = Math.round((10 + rng()*80)*100)/100;
        const rating = Math.round((3.7 + rng()*1.2)*10)/10;
        const reviews = Math.floor(rng()*4000) + 20;
        const sizes = pickMany(SIZES[cat]||['1kg'], 1 + Math.floor(rng()*Math.min(3,(SIZES[cat]||[]).length)));
        const base = { 'Protein':'Whey Protein','Creatine':'Creatine Monohydrate','Pre-Workout':'Pre-Workout','Amino Acids':'BCAA 2:1:1','Vitamins & Health':'Multivitamin' }[cat];
        const name = `${base} ${sizes[0]}${flavours[0]==='Unflavoured'?'':' ‚Äî '+flavours[0]}`;
        const form = pick(FORMS[cat]||['Powder']);
        const container = pick(CONTAINERS);
        const stock = rng() > 0.05;
        const dateAdded = NOW_MS - Math.floor(rng()*1000*60*60*24*30); // last 30 days
        const fastShip = rng() > 0.4; const freeShip = rng() > 0.5;
        return { id:i+1, name, brand, category:cat, flavours, sizes, diet, price, rating, reviews, form, container, stock, fastShip, freeShip, dateAdded };
      });

      // State
      const state = {
        q: '',
        cat: 'All',
        sort: 'relevance',
        filters: { category: new Set(), brand: new Set(), flavour: new Set(), diet: new Set(), form: new Set(), container: new Set(), size: new Set(), price: null, priceMin: 4, priceMax: 390, ratingMin: null, available: true },
        basket: new Map(), // id -> qty (kept for cart badge functionality)
        carouselPage: 0
      };

      // Helpers
      const $ = (s) => document.querySelector(s);
      const $$ = (s) => Array.from(document.querySelectorAll(s));
      const fmtPrice = (n) => `‚Ç¨${n.toFixed(2)}`;
      function stars(r){ const full=Math.round(r); return '‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ'.slice(0,full); }
      function unique(a){ return Array.from(new Set(a)); }
      // Amazon-like delivery copy: always show FREE delivery date as now + 4 days
      function deliveryDatePlusFour(){
        const d = new Date(NOW_MS + 4*86400000);
        // e.g., Thu, 16 Oct
        return d.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
      }

      // A11y helpers for modal focus trap
      function trapFocus(modal){
        const focusable = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        if(!focusable.length) return () => {};
        const first = focusable[0];
        const last = focusable[focusable.length - 1];
        function handler(e){
          if(e.key !== 'Tab') return;
          if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
          else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
        }
        modal.addEventListener('keydown', handler);
        return () => modal.removeEventListener('keydown', handler);
      }

      // Build filters
      function buildChecks(hostId, values, key, limit=8){
        const host = $(hostId);
        if(host) host.classList.add('chips');
        host.innerHTML = '';
        values.slice(0, limit).forEach(v => {
          const btn = document.createElement('button');
          btn.className = 'chip'+(state.filters[key].has(v)?' active':'');
          btn.type = 'button';
          btn.textContent = v;
          btn.setAttribute('data-val', v);
          btn.addEventListener('click', ()=>{
            if(state.filters[key].has(v)) state.filters[key].delete(v); else state.filters[key].add(v);
            render();
          });
          host.appendChild(btn);
        });
      }

      function buildChips(hostId, values, key){
        const host = $(hostId);
        host.innerHTML = values.map(v => `<div class="chip ${state.filters[key].has(v)?'active':''}" data-val="${v}">${v}</div>`).join('');
        $$(hostId+' .chip').forEach(el => el.addEventListener('click',()=>{
          const v = el.getAttribute('data-val');
          if(state.filters[key].has(v)) state.filters[key].delete(v); else state.filters[key].add(v);
          render();
        }));
      }

      // Suggestions
      const q = $('#q');
      let suggIndex = -1;
      function positionSugg(){
        const bar = document.querySelector('.searchbar');
        const s = document.getElementById('sugg');
        if(!bar || !s) return;
        const r = bar.getBoundingClientRect();
        const top = r.bottom + window.scrollY;

        // On desktop, exclude the category filter (select) from the dropdown width/left
        const isDesktop = window.matchMedia('(min-width: 769px)').matches;
        const selectEl = bar.querySelector('select');
        const selectW = (isDesktop && selectEl) ? selectEl.getBoundingClientRect().width : 0;

        const left = r.left + window.scrollX + selectW;
        const width = Math.max(0, r.width - selectW);
        s.style.top = top + 'px';
        s.style.left = left + 'px';
        s.style.width = width + 'px';
      }
      function showSugg(){
        const val = q.value.trim();
        const s = $('#sugg'); const box = $('#suggBox');
        if(!val){ s.style.display='none'; box.innerHTML=''; return; }
        const lc = val.toLowerCase();
        // Build Amazon-like typeahead phrases instead of listing products
        const suffixes = ['powder','capsules','tablets','1kg','vegan','vanilla','chocolate','best'];
        const brandHits = unique(DATA.map(p=>p.brand).filter(b=>b.toLowerCase().includes(lc))).slice(0,5);
        const formHits = unique(DATA.map(p=>p.form).filter(f=>f && f.toLowerCase().includes(lc))).slice(0,3);
        const flavourHits = unique(DATA.flatMap(p=>p.flavours||[]).filter(f=>f.toLowerCase().includes(lc))).slice(0,3);
        const baseRows = [val];
        // Add common suffixes
        suffixes.forEach(suf => baseRows.push(`${val} ${suf}`));
        // Add brand and attribute mixes similar to "<query> esn" or "<query> vanilla"
        brandHits.forEach(b => baseRows.push(`${val} ${b}`));
        flavourHits.forEach(f => baseRows.push(`${val} ${f.toLowerCase()}`));
        formHits.forEach(f => baseRows.push(`${val} ${f.toLowerCase()}`));
        // De-duplicate and cap
        const rows = unique(baseRows).slice(0, 10);
        if(rows.length===0){ s.style.display='none'; box.innerHTML=''; return; }
        function highlight(text){
          const i = text.toLowerCase().indexOf(lc);
          if(i===-1) return esc(text);
          const a = text.slice(0,i), b = text.slice(i, i+val.length), c = text.slice(i+val.length);
          return `${esc(a)}<span class="match">${esc(b)}</span>${esc(c)}`;
        }
        box.innerHTML = rows.map((text, idx) => (
          `<div class="row" data-idx="${idx}" data-text="${esc(text)}">`+
            `üîé <span class="txt">${highlight(text)}</span>`+
          `</div>`
        )).join('');
        positionSugg();
        s.style.display='block';
        $$('#sugg .row').forEach(r => r.addEventListener('click', () => {
          const text = r.getAttribute('data-text');
          q.value = text; state.q = text;
          render(); $('#sugg').style.display='none';
        }));
        suggIndex = -1;
      }
      function moveSugg(delta){
        const rows = $$('#sugg .row'); if(!rows.length) return;
        suggIndex = (suggIndex + delta + rows.length) % rows.length;
        rows.forEach((r,i)=>{ r.style.background = i===suggIndex ? '#fafafa' : ''; });
      }
      function chooseSugg(){ const rows = $$('#sugg .row'); if(rows[suggIndex]) rows[suggIndex].click(); }

      // Render products
      function render(){
        // Build left filter Checkboxes + Chips
        buildChecks('#fCategory', unique(DATA.map(p=>p.category)), 'category', 8);
        buildChecks('#fBrand', unique(DATA.map(p=>p.brand)), 'brand', brandLimit);
        buildChips('#fFlavour', unique(DATA.flatMap(p=>p.flavours)), 'flavour');
        buildChips('#fDiet', unique(DATA.flatMap(p=>p.diet||[])), 'diet');
        buildChecks('#fForm', unique(DATA.map(p=>p.form)), 'form', formLimit);
        buildChecks('#fContainer', unique(DATA.map(p=>p.container)), 'container', 8);
        buildChips('#fSize', unique(DATA.flatMap(p=>p.sizes||[])), 'size');

        // Active pills
        const pills = [];
        ['category','brand','flavour','diet','form','container','size'].forEach(k=>state.filters[k].forEach(v=>pills.push([k,v])));
        if(state.filters.price) pills.push(['price', state.filters.price]);
        if(state.filters.ratingMin) pills.push(['ratingMin', String(state.filters.ratingMin)]);
        if(state.filters.available === null) pills.push(['available', 'Include Out of Stock']);
        $('#activePills').innerHTML = pills.map(([k,v])=>`<span class="pill" data-k="${k}" data-v="${esc(v)}">${esc(v)} <span class="x">√ó</span></span>`).join('');
        $('#pills').innerHTML = $('#activePills').innerHTML;
        
        // Update mobile filters badge
        const badge = $('#filtersBadge');
        if (badge) {
          badge.textContent = pills.length;
          if (pills.length > 0) {
            badge.classList.add('active');
          } else {
            badge.classList.remove('active');
          }
        }
        
        // Show/hide Refine panel based on active filters
        const refinePanel = $('.filters .panel:first-child');
        if(pills.length === 0){
          refinePanel.style.display = 'none';
        } else {
          refinePanel.style.display = 'block';
        }
        $$('#activePills .pill, #pills .pill').forEach(el => el.addEventListener('click',()=>{
          const k = el.getAttribute('data-k'); const v = el.getAttribute('data-v');
          if(k==='price') state.filters.price=null; 
          else if(k==='ratingMin') state.filters.ratingMin=null; 
          else if(k==='available') state.filters.available=true; 
          else state.filters[k].delete(v);
          render();
        }));

        // Filter pipeline
        const qlc = state.q.toLowerCase();
        let list = DATA.filter(p => {
          if(state.cat && state.cat!=='All' && p.category !== state.cat) return false;
          if(qlc && !(p.name.toLowerCase().includes(qlc) || p.brand.toLowerCase().includes(qlc))) return false;
          if(state.filters.category.size && !state.filters.category.has(p.category)) return false;
          if(state.filters.brand.size && !state.filters.brand.has(p.brand)) return false;
          if(state.filters.flavour.size && !p.flavours.some(f=>state.filters.flavour.has(f))) return false;
          if(state.filters.diet.size && !((p.diet||[]).some(d=>state.filters.diet.has(d)))) return false;
          // Price range filter from slider
          const priceMin = state.filters.priceMin || PRICE_MIN;
          const priceMax = state.filters.priceMax || PRICE_MAX;
          if(!(p.price >= priceMin && p.price <= priceMax)) return false;
          
          // Quick price chip filter
          if(state.filters.price){
            const [a,b] = state.filters.price.split('-');
            const lo = a?+a:0; const hi = b?+b:Infinity;
            if(!(p.price >= lo && p.price <= hi)) return false;
          }
          if(state.filters.ratingMin && !(p.rating >= state.filters.ratingMin)) return false;
          if(state.filters.form.size && !state.filters.form.has(p.form)) return false;
          if(state.filters.container.size && !state.filters.container.has(p.container)) return false;
          if(state.filters.size.size && !((p.sizes||[]).some(s=>state.filters.size.has(s)))) return false;
          if(state.filters.available === true && !p.stock) return false; // Only show in-stock items by default
          return true;
        });

        // Sort
        if(state.sort==='price-asc') list.sort((a,b)=>a.price-b.price);
        if(state.sort==='price-desc') list.sort((a,b)=>b.price-a.price);
        if(state.sort==='rating-desc') list.sort((a,b)=>b.rating-a.rating);
        if(state.sort==='newest') list.sort((a,b)=>b.dateAdded-a.dateAdded);

        // Render grid
        const qtext = state.q ? ` for ${esc(state.q)}` : '';
        $('#count').textContent = `${list.length} results${qtext}`;
        const pageSize = 32; // Increased from 24 to match 4-column layout
        const totalPages = Math.max(1, Math.ceil(list.length / pageSize));
        if(state.page==null) state.page = 1;
        if(state.page>totalPages) state.page = totalPages;
        const start = (state.page-1)*pageSize;
        const pageItems = list.slice(start, start + pageSize);
        $('#grid').innerHTML = pageItems.map((p,i) => {
          const fp = (function(n){ const [w,f] = n.toFixed(2).split('.'); return {w,f}; })(p.price);
          const variants = (p.flavours||[]).slice(0,3).map(f=>`<span class="chip small">${esc(f)}</span>`).join(' ');
          const more = (p.flavours||[]).length>3 ? `<span class="chip small">+${(p.flavours||[]).length-3} more</span>` : '';
          const deliveryStr = deliveryDatePlusFour();
          return (
            `<div class="product" data-id="${p.id}">`+
              `<div class="thumb">IMG</div>`+
              `<div class="p-title">${esc(p.name)}</div>`+
              `<div class="small"><span class="p-brand">${esc(p.brand)}</span> ‚Ä¢ <span>${esc(p.category)}</span></div>`+
              `<div class="small"><span class="p-stars">${stars(p.rating)}</span> <span class="muted">(${p.reviews})</span></div>`+
              `<div class="price"><span class="currency">‚Ç¨</span><span class="whole">${fp.w}</span><span class="fraction">${fp.f}</span></div>`+
              `${p.stock ? `<div class="small">FREE delivery <b>${deliveryStr}</b> if you spend ‚Ç¨59</div>` : `<div class="small muted">Out of stock</div>`}`+
              `<div class="small">${variants} ${more}</div>`+
              `<div class="p-cta">`+
                `<button class="btn small add">Add to Basket</button>`+
              `</div>`+
            `</div>`
          );
        }).join('');

        // Wire add buttons
        $$('#grid .product .add').forEach(btn => btn.addEventListener('click', e => {
          const id = +e.target.closest('.product').getAttribute('data-id');
          state.basket.set(id, (state.basket.get(id)||0)+1);
          renderBasket();
          openBasket(); // Open basket when item is added
          const item = DATA.find(p=>p.id===id); const fp2 = (function(n){ const [w,f] = n.toFixed(2).split('.'); return `‚Ç¨${w}.${f}`; })(item.price);
          $('#ariaLive').textContent = `${item.name} added. ${fp2}. Basket ${Array.from(state.basket.values()).reduce((s,n)=>s+n,0)} items.`;
        }));

        // Wire filter chips for price/rating
        $$('#fPrice .chip').forEach(el => el.onclick = () => { state.filters.price = state.filters.price===el.getAttribute('data-val')?null:el.getAttribute('data-val'); render(); });
        $$('#fRating .chip').forEach(el => el.onclick = () => { const v=+el.getAttribute('data-val'); state.filters.ratingMin = state.filters.ratingMin===v?null:v; render(); });
        // Availability toggle
        const availToggle = $('#availToggle');
        if (availToggle) {
          if(state.filters.available === null) availToggle.classList.add('active'); else availToggle.classList.remove('active');
          availToggle.onclick = ()=>{ state.filters.available = (state.filters.available === null) ? true : null; render(); };
        }

        // Build pager
        const pager = $('#pager');
        pager.innerHTML = '';
        if(totalPages>1){
          for(let p=1;p<=totalPages;p++){
            const b = document.createElement('button'); b.className = 'btn small'+(p===state.page?' current':''); b.textContent = String(p);
            b.addEventListener('click', ()=>{ state.page = p; render(); window.scrollTo({ top: 0, behavior: 'smooth' }); });
            pager.appendChild(b);
          }
          const next = document.createElement('button'); next.className='btn small'; next.textContent='Next >';
          next.addEventListener('click', ()=>{ if(state.page<totalPages){ state.page++; render(); window.scrollTo({ top: 0, behavior: 'smooth' }); } });
          pager.appendChild(next);
        }

        // Related searches chips
        const relPanel = $('#relatedPanel'); const relHost = $('#relatedChips');
        const qlc2 = state.q.toLowerCase();
        let seeds = ['whey protein','creatine','bcaa','vegan protein','pre-workout'];
        if(qlc2){ const w = qlc2.split(/\s+/)[0]; seeds = [w+' powder', w+' 1kg', w+' vanilla', w+' chocolate', w+' best']; }
        relHost.innerHTML = seeds.slice(0,8).map(s=>`<div class=\"chip\">${esc(s)}</div>`).join('');
        $$('#relatedChips .chip').forEach(c=>c.addEventListener('click',()=>{ state.q = c.textContent; q.value = c.textContent; render(); }));
        relPanel.style.display = 'block';
        
        // Sync filters to mobile modal if open
        syncFiltersToModal();
        updateModalResultsCount();
      }

      function renderBasket(){
        const items = Array.from(state.basket.entries()).map(([id,qty])=>({ ...DATA.find(p=>p.id===id), qty }));
        const host = $('#basketItems');
        
        // Render basket items
        if(items.length === 0){
          host.innerHTML = '<div class="muted" style="padding: 10px 0; text-align: center; font-size: 10px;">No items yet</div>';
        } else {
          host.innerHTML = items.map(it => (
            `<div class="item-block" data-id="${it.id}">`+
              `<div class="pimg">IMG</div>`+
              `<div class="price"><span class="val">${fmtPrice(it.price)}</span></div>`+
              `<div class="qty-ctrl">`+
                `<button class="trash" title="Remove">üóë</button>`+
                `<span class="count">${it.qty}</span>`+
                `<button class="plus" title="Add">+</button>`+
              `</div>`+
            `</div>`
          )).join('');
          $$('#basketItems .item-block .plus').forEach(b => b.addEventListener('click', (e)=>{
            const id = +e.target.closest('.item-block').getAttribute('data-id');
            state.basket.set(id, (state.basket.get(id)||0)+1); renderBasket();
          }));
          $$('#basketItems .item-block .trash').forEach(b => b.addEventListener('click', (e)=>{
            const id = +e.target.closest('.item-block').getAttribute('data-id');
            state.basket.delete(id); renderBasket();
          }));
        }
        const subtotal = items.reduce((s,it)=>s+it.price*it.qty,0);
        $('#subtotal').textContent = fmtPrice(subtotal);
        const qty = items.reduce((s,it)=>s+it.qty,0);
        $('#cartBadge').textContent = String(qty);
        // Free delivery threshold copy - More compact text for narrow basket
        const THRESH = 35; // Adjusted threshold to match ~‚Ç¨35 from screenshot
        const diff = THRESH - subtotal;
        if (diff > 0) {
          $('#freeMsg').innerHTML = `Add <b>${fmtPrice(diff)}</b> of eligible items to qualify for <b>FREE</b> Delivery.`;
        } else {
          $('#freeMsg').innerHTML = `Your order qualifies for <b>FREE</b> Delivery.`;
        }
      }
      
      // Basket open/close functions
      function openBasket() {
        $('#basketPanel').classList.add('visible');
        document.body.classList.add('basket-open');
      }
      
      function closeBasket() {
        $('#basketPanel').classList.remove('visible');
        document.body.classList.remove('basket-open');
      }
      
      function toggleBasket() {
        if ($('#basketPanel').classList.contains('visible')) {
          closeBasket();
        } else {
          openBasket();
        }
      }

      // Clear all
      $('#clearAll').addEventListener('click', ()=>{
        state.filters = { category: new Set(), brand: new Set(), flavour: new Set(), diet: new Set(), form: new Set(), container: new Set(), size: new Set(), price: null, priceMin: 4, priceMax: 390, ratingMin: null, available: true };
        tempPriceMin = 4;
        tempPriceMax = 390;
        updatePriceSlider();
        render();
      });

      // Brand show more
      let brandLimit = 8;
      $('#brandMore').addEventListener('click', ()=>{ brandLimit = brandLimit===8 ? 20 : 8; $('#brandMore').textContent = brandLimit===8?'Show more':'Show less'; render(); });

      // Item Form show more/less
      let formLimit = 8;
      $('#formMore').addEventListener('click', ()=>{ formLimit = formLimit===8 ? 20 : 8; $('#formMore').textContent = formLimit===8?'See Less':'See more'; render(); });

      // Sort and category select
      $('#sort').addEventListener('change', ()=>{ state.sort = $('#sort').value; render(); });
      $('#catSelect').addEventListener('change', ()=>{ state.cat = $('#catSelect').value; render(); });

      // Search wiring
      q.addEventListener('input', ()=>{ state.q = q.value.trim(); showSugg(); render(); });
      q.addEventListener('keydown', (e)=>{
        if(e.key==='ArrowDown'){ e.preventDefault(); moveSugg(1); }
        if(e.key==='ArrowUp'){ e.preventDefault(); moveSugg(-1); }
        if(e.key==='Enter'){ chooseSugg(); }
      });
      $('#go').addEventListener('click', ()=>{ state.q = q.value.trim(); $('#sugg').style.display='none'; render(); });
      document.addEventListener('click', (e)=>{ if(!e.target.closest('.sugg') && !e.target.closest('.searchbar')) $('#sugg').style.display='none'; });
      window.addEventListener('resize', positionSugg);
      window.addEventListener('scroll', positionSugg, { passive: true });

      // Utils
      function esc(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

      // Price slider logic
      const PRICE_MIN = 0, PRICE_MAX = 400;
      let tempPriceMin = 4;
      let tempPriceMax = 390;
      
      function updatePriceSlider(){
        const min = tempPriceMin;
        const max = tempPriceMax;
        const minPercent = (min / PRICE_MAX) * 100;
        const maxPercent = (max / PRICE_MAX) * 100;
        $('#priceThumbMin').style.left = minPercent + '%';
        $('#priceThumbMax').style.left = maxPercent + '%';
        $('#priceTrack').style.left = minPercent + '%';
        $('#priceTrack').style.width = (maxPercent - minPercent) + '%';
        
        // Update display text
        const maxText = max >= PRICE_MAX ? `‚Ç¨${Math.round(max)}+` : `‚Ç¨${Math.round(max)}`;
        $('#priceDisplay').textContent = `‚Ç¨${Math.round(min)}‚Äì${maxText}`;
      }

      function setupPriceSlider(){
        const slider = $('#priceSlider');
        const thumbMin = $('#priceThumbMin');
        const thumbMax = $('#priceThumbMax');
        let activeThumb = null;

        function handleMouseDown(e, thumb){
          activeThumb = thumb;
          e.preventDefault();
        }
        
        thumbMin.addEventListener('mousedown', (e) => handleMouseDown(e, 'min'));
        thumbMax.addEventListener('mousedown', (e) => handleMouseDown(e, 'max'));

        document.addEventListener('mousemove', (e) => {
          if(!activeThumb) return;
          const rect = slider.getBoundingClientRect();
          const x = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
          const percent = x / rect.width;
          const value = Math.round(percent * PRICE_MAX);
          
          if(activeThumb === 'min'){
            tempPriceMin = Math.min(value, tempPriceMax - 1);
          } else {
            tempPriceMax = Math.max(value, tempPriceMin + 1);
          }
          updatePriceSlider();
        });

        document.addEventListener('mouseup', () => { 
          if(activeThumb){
            activeThumb = null;
          }
        });
        
        // Go button applies the filter
        $('#priceGo').addEventListener('click', () => {
          state.filters.priceMin = tempPriceMin;
          state.filters.priceMax = tempPriceMax;
          render();
        });
      }

      // Render browsing history carousel
      let historyItems = [];
      function renderBrowsingHistory(){
        if(historyItems.length === 0){
          // Pick 12 random products for the carousel (2 pages of 6)
          const indices = new Set();
          while(historyItems.length < 12 && historyItems.length < DATA.length){
            const idx = Math.floor(rng() * DATA.length);
            if(!indices.has(idx)){
              indices.add(idx);
              historyItems.push(DATA[idx]);
            }
          }
        }

        const page = state.carouselPage;
        const itemsPerPage = 6;
        const startIdx = page * itemsPerPage;
        const pageItems = historyItems.slice(startIdx, startIdx + itemsPerPage);
        const totalPages = Math.ceil(historyItems.length / itemsPerPage);

        const carousel = $('#historyCarousel');
        carousel.innerHTML = pageItems.map(p => {
          const fp = (function(n){ const [w,f] = n.toFixed(2).split('.'); return {w,f}; })(p.price);
          const deliveryDate = new Date(NOW_MS + (3 + Math.floor(rng() * 4)) * 86400000);
          const deliveryStr = deliveryDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
          return (
            `<div class="product" data-id="${p.id}">`+
              `<div class="thumb">IMG</div>`+
              `<div class="p-title">${esc(p.name)}</div>`+
              `<div class="small"><span class="p-stars">${stars(p.rating)}</span> <span class="muted">${p.reviews}</span></div>`+
              `<div class="price"><span class="currency">‚Ç¨</span><span class="whole">${fp.w}</span><span class="fraction">${fp.f}</span></div>`+
              `<div class="small muted">Get it as soon as ${deliveryStr}</div>`+
              `${p.stock ? `<div class="small" style="color: #007600; font-weight: 600;">FREE Delivery on orders over ‚Ç¨59</div>` : `<div class="small muted">Out of stock</div>`}`+
              `${rng() > 0.7 ? `<div class="small" style="color: #c45500;">üî• 1 sustainability certification</div>` : ''}`+
            `</div>`
          );
        }).join('');

        // Update navigation
        $('#carouselPrev').disabled = page === 0;
        $('#carouselNext').disabled = page >= totalPages - 1;
        $('#carouselPage').textContent = `Page ${page + 1} of ${totalPages}`;
      }

      function setupCarouselNav(){
        $('#carouselPrev').addEventListener('click', () => {
          if(state.carouselPage > 0){
            state.carouselPage--;
            renderBrowsingHistory();
          }
        });
        $('#carouselNext').addEventListener('click', () => {
          const totalPages = Math.ceil(historyItems.length / 6);
          if(state.carouselPage < totalPages - 1){
            state.carouselPage++;
            renderBrowsingHistory();
          }
        });
      }

      // Language selector
      function setupLanguageSelector(){
        $$('.lang-option').forEach(opt => {
          opt.addEventListener('click', (e) => {
            e.stopPropagation();
            const lang = opt.getAttribute('data-lang');
            $('#currentLang').textContent = lang;
            $$('.lang-option').forEach(o => o.classList.remove('active'));
            opt.classList.add('active');
          });
        });
      }

      // Auto-hide toolbar when topbar scrolls out
      let lastScrollTop = 0;
      let hasAutoScrolled = false;
      function handleToolbarAutoHide(){
        const topbar = $('.topbar');
        const toolbar = $('.toolbar');
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        
        // Reset flag when scrolling back up
        if(scrollTop < lastScrollTop){
          hasAutoScrolled = false;
        }
        
        // If scrolling down and topbar is out of view, auto-scroll past toolbar
        if(scrollTop > lastScrollTop && !hasAutoScrolled){
          const topbarBottom = topbar.offsetTop + topbar.offsetHeight;
          const toolbarHeight = toolbar.offsetHeight;
          
          // Once we've scrolled past the topbar, immediately scroll past toolbar too
          if(scrollTop >= topbarBottom && scrollTop < topbarBottom + toolbarHeight){
            window.scrollTo({
              top: topbarBottom + toolbarHeight,
              behavior: 'smooth'
            });
            hasAutoScrolled = true;
          }
        }
        
        lastScrollTop = scrollTop;
      }
      
      window.addEventListener('scroll', handleToolbarAutoHide, { passive: true });

      // Mobile Filters Modal
      function syncFiltersToModal() {
        const modal = $('#filtersModal');
        if (!modal.classList.contains('active')) return;
        buildFiltersSplitUI();
      }
      
      function openFiltersModal() {
        const modal = $('#filtersModal');
        buildFiltersSplitUI();
        // Show modal
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
      
      function closeFiltersModal() {
        const modal = $('#filtersModal');
        modal.classList.remove('active');
        document.body.style.overflow = '';
      }
      
      function applyFiltersModal() {
        closeFiltersModal();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
      
      function clearFiltersModal() {
        state.filters = { 
          category: new Set(), 
          brand: new Set(), 
          flavour: new Set(), 
          diet: new Set(), 
          form: new Set(), 
          container: new Set(), 
          size: new Set(), 
          price: null, 
          priceMin: 4, 
          priceMax: 390, 
          ratingMin: null, 
          available: true 
        };
        tempPriceMin = 4;
        tempPriceMax = 390;
        updatePriceSlider();
        render();
      }

      // Build two-pane filters UI in the modal
      function buildFiltersSplitUI(){
        const modalBody = $('#filtersModalBody');
        if(!modalBody) return;
        modalBody.innerHTML = '<div class="filters-split"><div class="filters-nav" id="filtersNav"></div><div class="filters-content" id="filtersContent"></div></div>';
        // Skip the desktop-only Refine panel but include all filter sections for mobile
        const panels = Array.from(document.querySelectorAll('.filters .panel')).filter((el, idx)=> idx!==0);
        const nav = $('#filtersNav');
        const content = $('#filtersContent');
        panels.forEach((p, idx)=>{
          const clone = p.cloneNode(true);
          // Remove duplicate ids inside the clone to avoid conflicts
          clone.querySelectorAll('[id]').forEach(el => el.removeAttribute('id'));
          const id = 'msec-'+idx;
          clone.id = id;
          if(idx===0) clone.classList.add('active');
          content.appendChild(clone);
          const titleEl = p.querySelector('.h');
          const title = (titleEl ? titleEl.textContent : ('Section '+(idx+1))).trim();
          const item = document.createElement('div');
          item.className = 'item'+(idx===0?' active':'');
          item.textContent = title;
          item.setAttribute('data-target', id);
          item.addEventListener('click', ()=>{
            $$('#filtersNav .item').forEach(i=>i.classList.remove('active'));
            item.classList.add('active');
            // show only this panel
            $$('#filtersContent .panel').forEach(pn=>pn.classList.remove('active'));
            const target = document.getElementById(id);
            if(target){
              target.classList.add('active');
              // Ensure it is scrolled to top of content area
              const cont = $('#filtersContent');
              if(cont) cont.scrollTop = target.offsetTop;
            }
          });
          nav.appendChild(item);
        });
        // Delegated click handling inside the content: apply filters immediately
        content.addEventListener('click', (e)=>{
          const chip = e.target.closest('.chip');
          if(!chip) return;
          const panel = chip.closest('.panel');
          if(!panel) return;
          const key = panel.getAttribute('data-key');
          const val = chip.getAttribute('data-val') || chip.textContent.trim();
          if(key === 'availability'){
            state.filters.available = (state.filters.available === null) ? true : null;
          } else if(key === 'price'){
            state.filters.price = (state.filters.price === val) ? null : val;
          } else if(key && state.filters[key] instanceof Set){
            if(state.filters[key].has(val)) state.filters[key].delete(val); else state.filters[key].add(val);
          }
          render();
        }, { capture: false });
        updateModalResultsCount();
      }

      function updateModalResultsCount(){
        const btn = $('#applyFilters');
        if(!btn) return;
        const countText = ($('#count') && $('#count').textContent) || '';
        const n = parseInt(countText, 10);
        if(!isNaN(n)) btn.textContent = `Show ${n} results`;
      }

      // Location modal open/close
      let releaseTrap = null;
      function openLocationModal(){
        const modal = $('#locationModal');
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        // Set initial focus to Sign in button
        const signin = modal.querySelector('.signin');
        if(signin) signin.focus();
        releaseTrap = trapFocus(modal);
      }
      function closeLocationModal(){
        $('#locationModal').classList.remove('active');
        document.body.style.overflow = '';
        if(releaseTrap){ releaseTrap(); releaseTrap = null; }
      }

      // Init
      function init(){
        setupPriceSlider();
        setupCarouselNav();
        setupLanguageSelector();
        updatePriceSlider();
        // Disable initial mock render in favor of real search flow
        try { renderBasket(); } catch(e) {}
        try { renderBrowsingHistory(); } catch(e) {}
        // Wire real integrations
        wireRealSearchInput();
        wireRealSorting();
        wireRealAvailability();
        initRealMode();
        
        // Wire basket controls
        $('.cart-nav').addEventListener('click', toggleBasket);
        $('#closeBasket').addEventListener('click', closeBasket);
        
        // Wire mobile filters modal
        $('#openFilters').addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); openFiltersModal(); });
        $('#closeFilters').addEventListener('click', closeFiltersModal);
        $('#applyFilters').addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); applyFiltersModal(); });
        $('#clearFilters').addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); clearFiltersModal(); });
        // Set dynamic country strings
        const label = $('#mobileDeliveryLabel');
        if(label) label.textContent = `Deliver to ${COUNTRY} ‚åµ`;
        const desktopCity = document.querySelector('.location-picker .city');
        if(desktopCity) desktopCity.textContent = COUNTRY;
        const deliverOutsideBtn = $('#deliverOutsideBtn');
        if(deliverOutsideBtn) deliverOutsideBtn.lastChild.textContent = `Deliver outside ${COUNTRY}`;

        // Wire location modal (mobile + desktop)
        $('#openLocation').addEventListener('click', openLocationModal);
        const openLocDesktop = document.getElementById('openLocationDesktop');
        if(openLocDesktop){ openLocDesktop.addEventListener('click', openLocationModal); }
        $('#closeLocationTop').addEventListener('click', closeLocationModal);
        $('#locationModal').addEventListener('click', (e)=>{ if(e.target.id==='locationModal') closeLocationModal(); });
        // ESC to close
        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeLocationModal(); });

        // Wire mobile filter bar actions
        const mf = $('#mobileFilterbar');
        if(mf){
          $('#openFilters2').addEventListener('click', openFiltersModal);
          $$('#mobileFilterbar .mf-chip[data-range]').forEach(chip => {
            chip.addEventListener('click', () => {
              $$('#mobileFilterbar .mf-chip').forEach(c=>c.classList.remove('active'));
              chip.classList.add('active');
              const range = chip.getAttribute('data-range')||'';
              const [a,b] = range.split('-');
              const lo = a ? +a : 0;
              const hi = b ? +b : 400;
              // apply as slider bounds to match pipeline and keep quick-price null
              tempPriceMin = lo; tempPriceMax = hi; updatePriceSlider();
              state.filters.price = null;
              state.filters.priceMin = lo; state.filters.priceMax = hi;
              render();
            });
          });
        }
        
        // Close modal on backdrop click
        $('#filtersModal').addEventListener('click', (e) => {
          if (e.target.id === 'filtersModal') {
            closeFiltersModal();
          }
        });
      }
      init();
    </script>
  </body>
</html>


