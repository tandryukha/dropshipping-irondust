<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin</title>
  <style>
    :root { --bg:#f6f7fb; --surface:#ffffff; --text:#0f172a; --muted:#64748b; --border:#e2e8f0; --primary:#6366f1; --primary-600:#5458e8; --success:#10b981; --danger:#ef4444; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; color: var(--text); background: radial-gradient(1200px 600px at 10% -10%, #eef2ff, transparent), radial-gradient(1000px 500px at 80% -20%, #ecfeff, transparent), var(--bg); }
    .container { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
    h1 { font-size: 24px; margin: 8px 0 20px; letter-spacing: -0.01em; }
    .subtle { color: var(--muted); font-size: 13px; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    .card { border: 1px solid var(--border); padding: 16px; border-radius: 12px; min-width: 280px; background: var(--surface); box-shadow: 0 6px 20px rgba(2,6,23,0.06); }
    .card h3 { margin: 0 0 10px; font-size: 16px; }
    button { padding: 10px 12px; cursor: pointer; border-radius: 10px; border: 1px solid transparent; background: var(--primary); color: white; font-weight: 600; letter-spacing: 0.01em; }
    button:hover { background: var(--primary-600); }
    button.ghost { background: transparent; color: var(--text); border-color: var(--border); }
    button.ghost:hover { border-color: #cbd5e1; }
    pre { background: #0b1020; color: #d1fae5; padding: 10px; border-radius: 10px; height: 260px; overflow: auto; border: 1px solid #0b1530; }
    label { display: block; margin: 8px 0 6px; }
    input[type="text"], textarea { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: #fbfdff; }
    .small { color: var(--muted); font-size: 12px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .muted { color:var(--muted); font-size:12px; }
    .toolbar { display:flex; gap:8px; align-items:center; }
    .spacer { height: 8px; }
    /* Fancy switches */
    .switch { display:inline-flex; align-items:center; gap:8px; cursor:pointer; user-select:none; }
    .switch .toggle-input { position: absolute; opacity: 0; width: 0; height: 0; }
    .switch .toggle-slider { position: relative; width: 44px; height: 24px; background: #cbd5e1; border-radius: 999px; transition: background .18s ease; box-shadow: inset 0 0 0 1px rgba(15,23,42,0.06); }
    .switch .toggle-slider::before { content:""; position:absolute; top:3px; left:3px; width:18px; height:18px; background:#ffffff; border-radius:999px; transition: transform .18s ease; box-shadow: 0 1px 2px rgba(2,6,23,0.15); }
    .switch .toggle-input:checked + .toggle-slider { background: var(--success); }
    .switch .toggle-input:checked + .toggle-slider::before { transform: translateX(20px); }
    .switch .toggle-label { font-size: 12px; color: var(--muted); }
    /* Flags list */
    #flags { display: grid; gap: 10px; }
    .flag { display:flex; align-items:center; gap: 12px; padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px; }
    .flag .flag-info { display:flex; flex-direction:column; }
    .flag .flag-name { font-weight: 600; font-size: 14px; }
    .flag .flag-status { font-size: 12px; color: var(--muted); }
  </style>
  <script>
    async function startIngest() {
      const clearAiEl = document.getElementById('ingClearAi');
      const clearTrEl = document.getElementById('ingClearTr');
      const clearAi = clearAiEl ? !!clearAiEl.checked : false;
      const clearTr = clearTrEl ? !!clearTrEl.checked : false;
      const payload = {};
      if (clearAi) payload.clearAiCache = true;
      if (clearTr) payload.clearTranslationCache = true;
      const res = await fetch('/admin/ingest/reingest', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      const js = await res.json();
      document.getElementById('ingestRunId').textContent = js.runId || '';
      streamLogs(js.runId);
      // Poll for completion and then fetch result
      await waitForCompletion(js.runId);
      await fetchAndRenderResult('ingest', js.runId);
    }
    async function startReindex() {
      const res = await fetch('/admin/index/reindex', { method: 'POST' });
      const js = await res.json();
      document.getElementById('indexRunId').textContent = js.runId || '';
      streamLogs(js.runId);
      await waitForCompletion(js.runId);
      await fetchAndRenderResult('index', js.runId);
    }
    let evtSrc;
    function streamLogs(runId) {
      if (!runId) return;
      if (evtSrc) evtSrc.close();
      evtSrc = new EventSource('/admin/runs/' + runId + '/logs/stream');
      const pre = document.getElementById('logs');
      pre.textContent = '';
      evtSrc.onmessage = (e) => { if (e.data) { pre.textContent += e.data + '\n'; pre.scrollTop = pre.scrollHeight; } };
      evtSrc.onerror = () => { /* keep open; browser will retry */ };
    }
    async function refreshLatest(type) {
      const res = await fetch('/admin/runs/latest?type=' + encodeURIComponent(type));
      const js = await res.json();
      document.getElementById(type + 'Status').textContent = js.status || '-';
      document.getElementById(type + 'RunId').textContent = js.runId || '';
      // Also try fetching latest result
      try { await fetchAndRenderLatestResult(type); } catch {}
      // Render processed/total if available
      const prog = document.getElementById(type + 'Progress');
      if (prog) {
        let txt = '';
        if (js && typeof js.processed === 'number') {
          txt = 'processed=' + js.processed + (js.total ? (' / ' + js.total) : '');
        }
        prog.textContent = txt;
      }
      // Render a link to open JSON (persisted result)
      const link = document.getElementById(type + 'OpenJson');
      if (link) {
        if (js && js.runId && js.resultPath && (js.status === 'completed' || js.status === 'failed')) {
          link.style.display = '';
          link.setAttribute('href', '/admin/runs/' + encodeURIComponent(js.runId) + '/result');
        } else {
          link.style.display = 'none';
          link.removeAttribute('href');
        }
      }
    }
    async function waitForCompletion(runId) {
      if (!runId) return;
      let tries = 0;
      while (tries < 600) { // up to ~5 min (600 * 500ms)
        tries++;
        try {
          const r = await fetch('/admin/runs/' + encodeURIComponent(runId));
          if (r.ok) {
            const js = await r.json();
            if (js.status === 'completed' || js.status === 'failed') break;
          }
        } catch {}
        await new Promise(res => setTimeout(res, 500));
      }
    }
    async function fetchAndRenderLatestResult(type) {
      const res = await fetch('/admin/runs/latest/result?type=' + encodeURIComponent(type));
      if (!res.ok) return;
      const js = await res.json();
      const el = document.getElementById(type + 'Result');
      if (el) el.textContent = JSON.stringify(js, null, 2);
    }
    async function fetchAndRenderResult(type, runId) {
      const res = await fetch('/admin/runs/' + encodeURIComponent(runId) + '/result');
      if (!res.ok) return;
      const js = await res.json();
      const el = document.getElementById(type + 'Result');
      if (el) el.textContent = JSON.stringify(js, null, 2);
    }
    async function loadFlags() {
      const res = await fetch('/feature-flags');
      const js = await res.json();
      const container = document.getElementById('flags');
      container.innerHTML = '';
      Object.entries(js).forEach(([k, v]) => {
        const div = document.createElement('div');
        div.className = 'flag';
        const id = 'flag_' + k.replace(/[^a-z0-9_\-]/gi, '_');
        div.innerHTML =
          '<div class="flag-info">' +
            '<div class="flag-name">' + k + '</div>' +
            '<div class="flag-status ' + (v ? 'on' : 'off') + '">' + (v ? 'Enabled' : 'Disabled') + '</div>' +
          '</div>' +
          '<label class="switch" style="margin-left:auto">' +
            '<input id="' + id + '" class="toggle-input" type="checkbox" ' + (v ? 'checked' : '') + ' onchange="toggleFlag(\'' + k + '\', this.checked)">' +
            '<span class="toggle-slider"></span>' +
          '</label>';
        container.appendChild(div);
      });
    }
    async function toggleFlag(key, enabled) {
      await fetch('/feature-flags/' + encodeURIComponent(key) + '?enabled=' + (enabled ? 'true':'false'), {
        method: 'POST', headers: { 'x-admin-key': 'dev_admin_key' }
      });
      loadFlags();
    }
    async function loadBlacklist() {
      const res = await fetch('/admin/blacklist');
      const js = await res.json();
      const list = Array.isArray(js.entries) ? js.entries : [];
      const c = document.getElementById('blList');
      c.innerHTML = '';
      if (list.length === 0) { c.textContent = 'No entries'; return; }
      list.forEach(e => {
        const row = document.createElement('div');
        row.className = 'row';
        const id = e.id || e['id'];
        row.innerHTML = '<code style="min-width:140px; display:inline-block;">' + id + '</code>' +
          '<span class="small" style="min-width:180px;">' + (e.reason || '') + '</span>' +
          '<button onclick="removeFromBlacklist(\'' + id + '\')">Remove</button>';
        c.appendChild(row);
      });
    }
    async function addToBlacklist() {
      const idsRaw = document.getElementById('blIds').value || '';
      const reason = document.getElementById('blReason').value || 'manual';
      await fetch('/admin/blacklist', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-admin-key': 'dev_admin_key' },
        body: JSON.stringify({ raw: idsRaw, reason })
      });
      document.getElementById('blIds').value = '';
      loadBlacklist();
    }
    async function removeFromBlacklist(id) {
      await fetch('/admin/blacklist/' + encodeURIComponent(id), {
        method: 'DELETE', headers: { 'x-admin-key': 'dev_admin_key' }
      });
      loadBlacklist();
    }

    // Helpers for targeted reingest and raw fetch
    function parseIds(input) {
      if (!input) return [];
      return input
        .split(/[\n,]+/)
        .map(s => (s || '').trim())
        .filter(Boolean)
        .map(s => s.toLowerCase().startsWith('wc_') ? s.slice(3) : s.toLowerCase().startsWith('wc') ? s.slice(2) : s)
        .map(s => s.replace(/[^0-9]/g, ''))
        .filter(Boolean)
        .map(s => Number(s))
        .filter(n => Number.isFinite(n));
    }

    async function targetedReingest() {
      const raw = document.getElementById('tgIds').value || '';
      const ids = parseIds(raw);
      const clearAi = document.getElementById('tgClearAi').checked;
      const clearTr = document.getElementById('tgClearTr').checked;
      const btn = document.getElementById('tgBtn');
      const out = document.getElementById('tgOut');
      if (ids.length === 0) { out.textContent = 'Provide at least one numeric ID'; return; }
      btn.disabled = true; btn.textContent = 'Reingesting…';
      out.textContent = '';
      try {
        const res = await fetch('/ingest/products', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': 'dev_admin_key',
            'x-clear-ai-cache': clearAi ? 'true' : 'false',
            'x-clear-translation-cache': clearTr ? 'true' : 'false'
          },
          body: JSON.stringify({ ids })
        });
        if (!res.ok) {
          out.textContent = 'HTTP ' + res.status;
          return;
        }
        const js = await res.json();
        out.textContent = JSON.stringify(js, null, 2);
      } catch (e) {
        out.textContent = String(e);
      } finally {
        btn.disabled = false; btn.textContent = 'Reingest';
      }
    }

    async function fetchSystemRaw() {
      const id = (document.getElementById('rawId').value || '').trim();
      const out = document.getElementById('sysRaw');
      out.textContent = '';
      if (!id) { out.textContent = 'Enter an id'; return; }
      try {
        const res = await fetch('/admin/raw/system/' + encodeURIComponent(id), {
          headers: { 'x-admin-key': 'dev_admin_key' }
        });
        if (!res.ok) { out.textContent = 'HTTP ' + res.status; return; }
        const js = await res.json();
        out.textContent = JSON.stringify(js, null, 2);
      } catch (e) { out.textContent = String(e); }
    }
    async function fetchWooRaw() {
      const id = (document.getElementById('rawId').value || '').trim();
      const out = document.getElementById('wooRaw');
      out.textContent = '';
      if (!id) { out.textContent = 'Enter an id'; return; }
      try {
        // Accept numeric or wc_*; backend normalizes
        const v = id.toLowerCase().startsWith('wc') ? id.replace(/^wc_?/i, '') : id;
        const res = await fetch('/admin/raw/woo/' + encodeURIComponent(v), {
          headers: { 'x-admin-key': 'dev_admin_key' }
        });
        if (!res.ok) { out.textContent = 'HTTP ' + res.status; return; }
        const js = await res.json();
        out.textContent = JSON.stringify(js, null, 2);
      } catch (e) { out.textContent = String(e); }
    }
    function copyEl(id) {
      try { navigator.clipboard.writeText(document.getElementById(id).textContent || ''); } catch {}
    }
    window.addEventListener('load', () => {
      refreshLatest('ingest');
      refreshLatest('index');
      loadFlags();
      loadBlacklist();
      // Poll every 1s while something is running
      setInterval(async () => {
        try {
          const res = await fetch('/admin/runs/latest?type=ingest');
          const js = await res.json();
          if (js && (js.status === 'running' || js.status === 'completed' || js.status === 'failed')) {
            await refreshLatest('ingest');
          }
        } catch {}
      }, 1000);
    });
  </script>
  </head>
<body>
  <div class="container">
    <h1>Admin Dashboard <span class="subtle">maintenance + controls</span></h1>
    <div class="row">
      <div class="card">
        <h3>Ingest</h3>
        <div class="toolbar">
          <button onclick="startIngest()">Start Reingest</button>
          <button class="ghost" onclick="refreshLatest('ingest')">Refresh</button>
        </div>
        <div class="toolbar" style="margin-top:6px; gap:14px;">
          <label class="switch"><input id="ingClearAi" class="toggle-input" type="checkbox" /><span class="toggle-slider"></span><span class="toggle-label">Clear AI cache</span></label>
          <label class="switch"><input id="ingClearTr" class="toggle-input" type="checkbox" /><span class="toggle-slider"></span><span class="toggle-label">Clear translation cache</span></label>
        </div>
        <div class="spacer"></div>
        <div class="small">Latest status: <b id="ingestStatus">-</b></div>
        <div class="small" id="ingestProgress"></div>
        <div class="small">Latest runId: <code id="ingestRunId"></code></div>
        <div class="spacer"></div>
        <div class="toolbar" style="margin-top:6px; gap:10px; align-items:center;">
          <div class="small">Latest result</div>
          <a id="ingestOpenJson" class="small" style="margin-left:auto; text-decoration:underline; display:none" target="_blank">Open JSON</a>
        </div>
        <pre id="ingestResult"></pre>
      </div>
      <div class="card">
        <h3>Index</h3>
        <div class="toolbar">
          <button onclick="startReindex()">Start Reindex</button>
          <button class="ghost" onclick="refreshLatest('index')">Refresh</button>
        </div>
        <div class="spacer"></div>
        <div class="small">Latest status: <b id="indexStatus">-</b></div>
        <div class="small" id="indexProgress"></div>
        <div class="small">Latest runId: <code id="indexRunId"></code></div>
        <div class="spacer"></div>
        <div class="toolbar" style="margin-top:6px; gap:10px; align-items:center;">
          <div class="small">Latest result</div>
          <a id="indexOpenJson" class="small" style="margin-left:auto; text-decoration:underline; display:none" target="_blank">Open JSON</a>
        </div>
        <pre id="indexResult"></pre>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <h3>Feature Flags</h3>
      <div id="flags"></div>
    </div>

    <div class="card" style="margin-top:16px; width: 100%;">
      <h3>Blacklist</h3>
      <div class="row">
        <div style="min-width:320px;">
          <label>IDs (wc_123 or just 123, comma/newline separated)</label>
          <textarea id="blIds" style="width:100%; height:80px;"></textarea>
          <label>Reason</label>
          <input id="blReason" type="text" placeholder="manual" />
          <div style="margin-top:8px;">
            <button onclick="addToBlacklist()">Blacklist + Deindex</button>
          </div>
        </div>
        <div style="flex:1; min-width:320px;">
          <label>Current Blacklist</label>
          <div id="blList"></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px; width: 100%;">
      <h3>Targeted Reingest</h3>
      <div class="row">
        <div style="min-width:360px; flex:1;">
          <label>IDs to reingest (comma/newline; accepts 123, wc123, wc_123)</label>
          <textarea id="tgIds" style="width:100%; height:88px;"></textarea>
          <div class="toolbar" style="margin-top:6px; gap:14px;">
            <label class="switch"><input id="tgClearAi" class="toggle-input" type="checkbox" /><span class="toggle-slider"></span><span class="toggle-label">Clear AI cache</span></label>
            <label class="switch"><input id="tgClearTr" class="toggle-input" type="checkbox" /><span class="toggle-slider"></span><span class="toggle-label">Clear translation cache</span></label>
            <span style="flex:1"></span>
            <button id="tgBtn" onclick="targetedReingest()">Reingest</button>
          </div>
        </div>
        <div style="min-width:360px; flex:1;">
          <label class="small">Ingest report</label>
          <pre id="tgOut"></pre>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px; width: 100%;">
      <h3>Raw Inspect</h3>
      <div class="row" style="align-items:flex-start;">
        <div style="min-width:260px;">
          <label>Product ID (wc_123 or 123)</label>
          <input id="rawId" type="text" placeholder="wc_31476" />
          <div class="toolbar" style="margin-top:8px;">
            <button onclick="fetchSystemRaw()">Fetch System</button>
            <button class="ghost" onclick="fetchWooRaw()">Fetch Woo</button>
          </div>
        </div>
        <div class="grid" style="flex:1; min-width:480px;">
          <div>
            <div class="toolbar"><span class="small">System Raw</span><button style="margin-left:auto" class="ghost" onclick="copyEl('sysRaw')">Copy</button></div>
            <pre id="sysRaw"></pre>
          </div>
          <div>
            <div class="toolbar"><span class="small">Woo Raw</span><button style="margin-left:auto" class="ghost" onclick="copyEl('wooRaw')">Copy</button></div>
            <pre id="wooRaw"></pre>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px; width: 100%;">
      <h3>Live Logs</h3>
      <pre id="logs"></pre>
    </div>
  </div>
</body>
</html>


