<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    h1 { font-size: 20px; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; padding: 16px; border-radius: 8px; min-width: 280px; }
    button { padding: 8px 12px; cursor: pointer; }
    pre { background: #111; color: #0f0; padding: 8px; border-radius: 6px; height: 240px; overflow: auto; }
    label { display: block; margin: 8px 0 4px; }
    input[type="text"] { width: 100%; padding: 8px; }
    .small { color: #666; font-size: 12px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .muted { color:#666; font-size:12px; }
    .toolbar { display:flex; gap:8px; align-items:center; }
  </style>
  <script>
    async function startIngest() {
      const res = await fetch('/admin/ingest/reingest', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}' });
      const js = await res.json();
      document.getElementById('ingestRunId').textContent = js.runId || '';
      streamLogs(js.runId);
    }
    async function startReindex() {
      const res = await fetch('/admin/index/reindex', { method: 'POST' });
      const js = await res.json();
      document.getElementById('indexRunId').textContent = js.runId || '';
      streamLogs(js.runId);
    }
    let evtSrc;
    function streamLogs(runId) {
      if (!runId) return;
      if (evtSrc) evtSrc.close();
      evtSrc = new EventSource('/admin/runs/' + runId + '/logs/stream');
      const pre = document.getElementById('logs');
      pre.textContent = '';
      evtSrc.onmessage = (e) => { if (e.data) { pre.textContent += e.data + '\n'; pre.scrollTop = pre.scrollHeight; } };
      evtSrc.onerror = () => { /* keep open; browser will retry */ };
    }
    async function refreshLatest(type) {
      const res = await fetch('/admin/runs/latest?type=' + encodeURIComponent(type));
      const js = await res.json();
      document.getElementById(type + 'Status').textContent = js.status || '-';
      document.getElementById(type + 'RunId').textContent = js.runId || '';
    }
    async function loadFlags() {
      const res = await fetch('/feature-flags');
      const js = await res.json();
      const container = document.getElementById('flags');
      container.innerHTML = '';
      Object.entries(js).forEach(([k, v]) => {
        const div = document.createElement('div');
        div.className = 'row';
        div.innerHTML = '<label>' + k + '</label>' +
          '<button onclick="toggleFlag(\'' + k + '\',' + (!v) + ')">' + (v ? 'Disable' : 'Enable') + '</button>' +
          '<span class="small">current: ' + v + '</span>';
        container.appendChild(div);
      });
    }
    async function toggleFlag(key, enabled) {
      await fetch('/feature-flags/' + encodeURIComponent(key) + '?enabled=' + (enabled ? 'true':'false'), {
        method: 'POST', headers: { 'x-admin-key': 'dev_admin_key' }
      });
      loadFlags();
    }
    async function loadBlacklist() {
      const res = await fetch('/admin/blacklist');
      const js = await res.json();
      const list = Array.isArray(js.entries) ? js.entries : [];
      const c = document.getElementById('blList');
      c.innerHTML = '';
      if (list.length === 0) { c.textContent = 'No entries'; return; }
      list.forEach(e => {
        const row = document.createElement('div');
        row.className = 'row';
        const id = e.id || e['id'];
        row.innerHTML = '<code style="min-width:140px; display:inline-block;">' + id + '</code>' +
          '<span class="small" style="min-width:180px;">' + (e.reason || '') + '</span>' +
          '<button onclick="removeFromBlacklist(\'' + id + '\')">Remove</button>';
        c.appendChild(row);
      });
    }
    async function addToBlacklist() {
      const idsRaw = document.getElementById('blIds').value || '';
      const reason = document.getElementById('blReason').value || 'manual';
      await fetch('/admin/blacklist', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-admin-key': 'dev_admin_key' },
        body: JSON.stringify({ raw: idsRaw, reason })
      });
      document.getElementById('blIds').value = '';
      loadBlacklist();
    }
    async function removeFromBlacklist(id) {
      await fetch('/admin/blacklist/' + encodeURIComponent(id), {
        method: 'DELETE', headers: { 'x-admin-key': 'dev_admin_key' }
      });
      loadBlacklist();
    }

    // Helpers for targeted reingest and raw fetch
    function parseIds(input) {
      if (!input) return [];
      return input
        .split(/[\n,]+/)
        .map(s => (s || '').trim())
        .filter(Boolean)
        .map(s => s.toLowerCase().startsWith('wc_') ? s.slice(3) : s.toLowerCase().startsWith('wc') ? s.slice(2) : s)
        .map(s => s.replace(/[^0-9]/g, ''))
        .filter(Boolean)
        .map(s => Number(s))
        .filter(n => Number.isFinite(n));
    }

    async function targetedReingest() {
      const raw = document.getElementById('tgIds').value || '';
      const ids = parseIds(raw);
      const clearAi = document.getElementById('tgClearAi').checked;
      const clearTr = document.getElementById('tgClearTr').checked;
      const btn = document.getElementById('tgBtn');
      const out = document.getElementById('tgOut');
      if (ids.length === 0) { out.textContent = 'Provide at least one numeric ID'; return; }
      btn.disabled = true; btn.textContent = 'Reingestingâ€¦';
      out.textContent = '';
      try {
        const res = await fetch('/ingest/products', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': 'dev_admin_key',
            'x-clear-ai-cache': clearAi ? 'true' : 'false',
            'x-clear-translation-cache': clearTr ? 'true' : 'false'
          },
          body: JSON.stringify({ ids })
        });
        if (!res.ok) {
          out.textContent = 'HTTP ' + res.status;
          return;
        }
        const js = await res.json();
        out.textContent = JSON.stringify(js, null, 2);
      } catch (e) {
        out.textContent = String(e);
      } finally {
        btn.disabled = false; btn.textContent = 'Reingest';
      }
    }

    async function fetchSystemRaw() {
      const id = (document.getElementById('rawId').value || '').trim();
      const out = document.getElementById('sysRaw');
      out.textContent = '';
      if (!id) { out.textContent = 'Enter an id'; return; }
      try {
        const res = await fetch('/admin/raw/system/' + encodeURIComponent(id), {
          headers: { 'x-admin-key': 'dev_admin_key' }
        });
        if (!res.ok) { out.textContent = 'HTTP ' + res.status; return; }
        const js = await res.json();
        out.textContent = JSON.stringify(js, null, 2);
      } catch (e) { out.textContent = String(e); }
    }
    async function fetchWooRaw() {
      const id = (document.getElementById('rawId').value || '').trim();
      const out = document.getElementById('wooRaw');
      out.textContent = '';
      if (!id) { out.textContent = 'Enter an id'; return; }
      try {
        // Accept numeric or wc_*; backend normalizes
        const v = id.toLowerCase().startsWith('wc') ? id.replace(/^wc_?/i, '') : id;
        const res = await fetch('/admin/raw/woo/' + encodeURIComponent(v), {
          headers: { 'x-admin-key': 'dev_admin_key' }
        });
        if (!res.ok) { out.textContent = 'HTTP ' + res.status; return; }
        const js = await res.json();
        out.textContent = JSON.stringify(js, null, 2);
      } catch (e) { out.textContent = String(e); }
    }
    function copyEl(id) {
      try { navigator.clipboard.writeText(document.getElementById(id).textContent || ''); } catch {}
    }
    window.addEventListener('load', () => {
      refreshLatest('ingest');
      refreshLatest('index');
      loadFlags();
      loadBlacklist();
    });
  </script>
  </head>
<body>
  <h1>Admin Dashboard</h1>
  <div class="row">
    <div class="card">
      <h3>Ingest</h3>
      <button onclick="startIngest()">Start Reingest</button>
      <div>Latest status: <b id="ingestStatus">-</b></div>
      <div>Latest runId: <code id="ingestRunId"></code></div>
    </div>
    <div class="card">
      <h3>Index</h3>
      <button onclick="startReindex()">Start Reindex</button>
      <div>Latest status: <b id="indexStatus">-</b></div>
      <div>Latest runId: <code id="indexRunId"></code></div>
    </div>
  </div>

  <div class="card" style="margin-top:16px;">
    <h3>Feature Flags</h3>
    <div id="flags"></div>
  </div>

  <div class="card" style="margin-top:16px; width: 100%;">
    <h3>Blacklist</h3>
    <div class="row">
      <div style="min-width:320px;">
        <label>IDs (wc_123 or just 123, comma/newline separated)</label>
        <textarea id="blIds" style="width:100%; height:80px;"></textarea>
        <label>Reason</label>
        <input id="blReason" type="text" placeholder="manual" />
        <div style="margin-top:8px;">
          <button onclick="addToBlacklist()">Blacklist + Deindex</button>
        </div>
      </div>
      <div style="flex:1; min-width:320px;">
        <label>Current Blacklist</label>
        <div id="blList"></div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:16px; width: 100%;">
    <h3>Targeted Reingest</h3>
    <div class="row">
      <div style="min-width:360px; flex:1;">
        <label>IDs to reingest (comma/newline; accepts 123, wc123, wc_123)</label>
        <textarea id="tgIds" style="width:100%; height:88px;"></textarea>
        <div class="toolbar" style="margin-top:6px;">
          <label class="small"><input id="tgClearAi" type="checkbox" /> clear AI cache</label>
          <label class="small"><input id="tgClearTr" type="checkbox" /> clear translation cache</label>
          <button id="tgBtn" onclick="targetedReingest()">Reingest</button>
        </div>
      </div>
      <div style="min-width:360px; flex:1;">
        <label class="small">Ingest report</label>
        <pre id="tgOut"></pre>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:16px; width: 100%;">
    <h3>Raw Inspect</h3>
    <div class="row" style="align-items:flex-start;">
      <div style="min-width:260px;">
        <label>Product ID (wc_123 or 123)</label>
        <input id="rawId" type="text" placeholder="wc_31476" />
        <div class="toolbar" style="margin-top:8px;">
          <button onclick="fetchSystemRaw()">Fetch System</button>
          <button onclick="fetchWooRaw()">Fetch Woo</button>
        </div>
      </div>
      <div class="grid" style="flex:1; min-width:480px;">
        <div>
          <div class="toolbar"><span class="small">System Raw</span><button style="margin-left:auto" onclick="copyEl('sysRaw')">Copy</button></div>
          <pre id="sysRaw"></pre>
        </div>
        <div>
          <div class="toolbar"><span class="small">Woo Raw</span><button style="margin-left:auto" onclick="copyEl('wooRaw')">Copy</button></div>
          <pre id="wooRaw"></pre>
        </div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:16px; width: 100%;">
    <h3>Live Logs</h3>
    <pre id="logs"></pre>
  </div>
</body>
</html>


